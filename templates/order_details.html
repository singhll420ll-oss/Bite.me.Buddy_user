{% extends "base.html" %}

{% block title %}Order #{{ order.order_id }} Details{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Top Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <h1>Order Details</h1>
            <p class="welcome-text">Order #{{ order.order_id }} - {{ order.status|title }}</p>
        </div>
        <div class="header-right">
            <img src="{{ session.get('profile_pic', '') }}" 
                 alt="Profile" class="profile-pic"
                 onerror="this.src='{{ url_for('static', filename='default-avatar.jpg') }}'">
        </div>
    </header>

    <!-- Back Button -->
    <div style="padding: 0 20px; margin-top: 10px;">
        <a href="{{ url_for('order_history') }}" class="btn btn-back">
            <i class="fas fa-arrow-left"></i> Back to Orders
        </a>
    </div>

    <!-- Order Details Content -->
    <main class="main-content">
        <div class="order-details-container">
            <!-- Order Header Card -->
            <div class="order-header-card">
                <div class="order-header-info">
                    <h2>Order #{{ order.order_id }}</h2>
                    <div class="order-meta">
                        <span class="order-date">
                            <i class="far fa-calendar"></i>
                            {{ order.order_date_formatted or order.order_date or 'Date not available' }}
                        </span>
                        <span class="order-status-badge status-{{ order.status|lower if order.status else 'pending' }}">
                            {{ order.status|title if order.status else 'Pending' }}
                        </span>
                    </div>
                </div>
                
                {% if order.delivery_date_formatted %}
                <div class="delivery-info">
                    <i class="fas fa-truck"></i>
                    <span>Expected Delivery: {{ order.delivery_date_formatted }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Order Summary Cards -->
            <div class="summary-cards-grid">
                <!-- Customer Info Card -->
                <div class="summary-card">
                    <h3><i class="fas fa-user"></i> Customer Information</h3>
                    <div class="summary-content">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">{{ order.user_name or session.get('full_name', '') }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">{{ order.user_email or session.get('email', '') }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">{{ order.user_phone or session.get('phone', '') }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address:</span>
                            <span class="info-value">{{ order.user_address or session.get('location', '') }}</span>
                        </div>
                    </div>
                </div>

                <!-- Order Info Card -->
                <div class="summary-card">
                    <h3><i class="fas fa-receipt"></i> Order Information</h3>
                    <div class="summary-content">
                        <div class="info-row">
                            <span class="info-label">Payment Mode:</span>
                            <span class="info-value payment-mode">{{ order.payment_mode|default('COD') }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Payment Status:</span>
                            <span class="info-value payment-status status-{{ order.payment_status|default('pending')|lower }}">
                                {{ order.payment_status|default('Pending')|title }}
                            </span>
                        </div>
                        {% if order.transaction_id %}
                        <div class="info-row">
                            <span class="info-label">Transaction ID:</span>
                            <span class="info-value transaction-id">{{ order.transaction_id }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span class="info-label">Delivery Location:</span>
                            <span class="info-value delivery-location">{{ order.delivery_location|default('Location not specified') }}</span>
                        </div>
                        {% if order.notes %}
                        <div class="info-row">
                            <span class="info-label">Notes:</span>
                            <span class="info-value">{{ order.notes }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Payment Summary Card -->
                <div class="summary-card">
                    <h3><i class="fas fa-wallet"></i> Payment Summary</h3>
                    <div class="summary-content">
                        <div class="info-row">
                            <span class="info-label">Subtotal:</span>
                            <span class="info-value">‚Çπ{{ "%.2f"|format(order.total_amount|float) }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Delivery Charge:</span>
                            <span class="info-value">‚Çπ0.00</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Taxes:</span>
                            <span class="info-value">‚Çπ0.00</span>
                        </div>
                        <div class="info-row total-row">
                            <span class="info-label">Total Amount:</span>
                            <span class="info-value total-amount">‚Çπ{{ "%.2f"|format(order.total_amount|float) }}</span>
                        </div>
                        {% if order.payment_date %}
                        <div class="info-row">
                            <span class="info-label">Payment Date:</span>
                            <span class="info-value">{{ order.payment_date }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Order Items Section -->
            <div class="order-items-section">
                <h3><i class="fas fa-box"></i> Order Items ({{ items|length if items else 0 }})</h3>
                
                {% if items and items|length > 0 %}
                    <div class="order-items-list">
                        {% for item in items %}
                            <div class="order-item-card">
                                <!-- Item Photo -->
                                <div class="item-photo-container">
                                    {% if item.photo %}
                                        <img src="{{ item.photo }}" 
                                             alt="{{ item.name }}"
                                             class="item-photo"
                                             onerror="this.src='{{ url_for('static', filename='default-item.jpg') }}'">
                                    {% else %}
                                        <div class="item-photo-placeholder">
                                            <i class="fas fa-{{ 'concierge-bell' if item.type == 'service' else 'utensils' }}"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Item Details -->
                                <div class="item-details-container">
                                    <div class="item-header">
                                        <span class="item-type-badge {{ item.type|default('unknown')|lower }}">
                                            {{ item.type|default('item')|title }}
                                        </span>
                                        <h4 class="item-name">{{ item.name }}</h4>
                                    </div>
                                    
                                    {% if item.description %}
                                    <p class="item-description">{{ item.description }}</p>
                                    {% endif %}
                                    
                                    <div class="item-meta">
                                        <span class="item-quantity">
                                            <i class="fas fa-hashtag"></i> {{ item.quantity }} units
                                        </span>
                                        <span class="item-price">
                                            <i class="fas fa-tag"></i> ‚Çπ{{ "%.2f"|format(item.price|float) }} each
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Item Total -->
                                <div class="item-total-container">
                                    <div class="item-total-amount">
                                        ‚Çπ{{ "%.2f"|format(item.price|float * item.quantity) }}
                                    </div>
                                    <div class="item-unit-price">
                                        ‚Çπ{{ "%.2f"|format(item.price|float) }} √ó {{ item.quantity }}
                                    </div>
                                </div>
                                
                                <!-- Reorder Button -->
                                <div class="item-actions">
                                    <button class="btn btn-outline btn-sm reorder-btn" 
                                            data-item-type="{{ item.type }}"
                                            data-item-id="{{ item.item_id if item.item_id else 0 }}">
                                        <i class="fas fa-redo"></i> <span class="btn-text">Reorder</span>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-items-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>No items found for this order</p>
                    </div>
                {% endif %}
            </div>

            <!-- Order Actions -->
            <div class="order-actions-section">
                <div class="action-buttons">
                    <button class="btn btn-info print-btn" onclick="generateGovernmentInvoice()">
                        <i class="fas fa-file-invoice"></i> <span class="btn-text">Download Official Invoice</span>
                    </button>
                    
                    {% if order.status|lower == 'pending' %}
                    <button class="btn btn-warning cancel-btn" data-order-id="{{ order.order_id }}">
                        <i class="fas fa-times-circle"></i> <span class="btn-text">Cancel Order</span>
                    </button>
                    {% endif %}
                    
                    <a href="{{ url_for('order_history') }}" class="btn btn-outline back-btn">
                        <i class="fas fa-arrow-left"></i> <span class="btn-text">Back to Orders</span>
                    </a>
                </div>
                
                <!-- Order Timeline -->
                <div class="order-timeline">
                    <h4><i class="fas fa-history"></i> Order Timeline</h4>
                    <div class="timeline">
                        <div class="timeline-item {% if order.status %}completed{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-title">Order Placed</span>
                                <span class="timeline-time">{{ order.order_date_formatted or order.order_date }}</span>
                            </div>
                        </div>
                        <div class="timeline-item {% if order.status|lower in ['processing', 'completed', 'delivered'] %}completed{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-title">Order Confirmed</span>
                                <span class="timeline-time">
                                    {% if order.status|lower in ['processing', 'completed', 'delivered'] %}
                                        {{ order.order_date_formatted or order.order_date }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="timeline-item {% if order.status|lower in ['completed', 'delivered'] %}completed{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-title">Out for Delivery</span>
                                <span class="timeline-time">
                                    {% if order.status|lower in ['completed', 'delivered'] %}
                                        {{ order.delivery_date_formatted or 'Recently' }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="timeline-item {% if order.status|lower == 'completed' %}completed{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <span class="timeline-title">Delivered</span>
                                <span class="timeline-time">
                                    {% if order.status|lower == 'completed' %}
                                        {{ order.delivery_date_formatted or 'Completed' }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="{{ url_for('services') }}" class="nav-item">
            <i class="fas fa-concierge-bell"></i>
            <span>Services</span>
        </a>
        <a href="{{ url_for('menu') }}" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="{{ url_for('cart') }}" class="nav-item">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="{{ url_for('order_history') }}" class="nav-item active">
            <i class="fas fa-history"></i>
            <span>Orders</span>
        </a>
        <a href="{{ url_for('profile') }}" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>
</div>

<!-- Order Details Styles -->
<style>
    /* Base Styles */
    .order-details-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .btn-back {
        background: none;
        color: #4f46e5;
        border: 2px solid #4f46e5;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    
    .btn-back:hover {
        background: #4f46e5;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
    }
    
    /* Header Card */
    .order-header-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    
    .order-header-info h2 {
        margin: 0 0 10px 0;
        font-size: 1.8rem;
    }
    
    .order-meta {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .order-date {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        opacity: 0.9;
    }
    
    .order-status-badge {
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 100px;
        text-align: center;
    }
    
    .delivery-info {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
    }
    
    /* Summary Cards Grid */
    .summary-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: 1px solid #eaeaea;
        transition: transform 0.3s ease;
    }
    
    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .info-label {
        color: #6b7280;
        font-weight: 500;
        min-width: 140px;
    }
    
    /* Order Items */
    .order-items-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: 1px solid #eaeaea;
    }
    
    .order-items-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .order-item-card {
        display: grid;
        grid-template-columns: 80px 1fr auto auto;
        gap: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 10px;
        align-items: center;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .order-item-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .item-total-container {
        text-align: right;
        min-width: 120px;
    }
    
    /* Buttons */
    .action-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        min-height: 44px;
        box-sizing: border-box;
    }
    
    .btn-text {
        display: inline;
    }
    
    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
    }
    
    /* Status Colors */
    .status-pending { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); }
    .status-completed { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); }
    .status-processing { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-cancelled { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); }
    
    /* Button Colors */
    .btn-info { background: #3b82f6; color: white; }
    .btn-warning { background: #fbbf24; color: #92400e; }
    .btn-outline { background: white; color: #4f46e5; border: 2px solid #4f46e5; }
    
    /* Item Type Badges */
    .item-type-badge.service { background: #e0f2fe; color: #0369a1; }
    .item-type-badge.menu { background: #dcfce7; color: #166534; }
    
    /* ========== RESPONSIVE DESIGN ========== */
    
    /* Large Desktop (1200px+) */
    @media (min-width: 1200px) {
        .order-details-container {
            padding: 30px 20px;
        }
        
        .summary-cards-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    /* Desktop (992px - 1199px) */
    @media (min-width: 992px) and (max-width: 1199px) {
        .order-details-container {
            padding: 25px;
        }
        
        .order-item-card {
            grid-template-columns: 70px 1fr auto auto;
            gap: 12px;
        }
        
        .item-total-container {
            min-width: 100px;
        }
    }
    
    /* Tablet (768px - 991px) -->
    @media (min-width: 768px) and (max-width: 991px) {
        .order-details-container {
            padding: 20px;
        }
        
        .order-header-card {
            padding: 20px;
        }
        
        .order-header-info h2 {
            font-size: 1.6rem;
        }
        
        .summary-cards-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .order-item-card {
            grid-template-columns: 70px 1fr auto;
            grid-template-rows: auto auto;
        }
        
        .item-actions {
            grid-column: 3;
            grid-row: 2;
        }
        
        .item-total-container {
            grid-column: 2;
            grid-row: 2;
            text-align: left;
            min-width: auto;
        }
        
        .action-buttons {
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
    }
    
    /* Large Mobile (576px - 767px) - 15% COMPRESSION -->
    @media (min-width: 576px) and (max-width: 767px) {
        .order-details-container {
            padding: 15px;
        }
        
        .order-header-card {
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .order-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        /* 15% Font Size Reduction */
        .order-header-info h2 {
            font-size: 1.36rem; /* 1.6rem √ó 0.85 */
        }
        
        .order-date {
            font-size: 0.808rem; /* 0.95rem √ó 0.85 */
        }
        
        .order-status-badge {
            font-size: 0.723rem; /* 0.85rem √ó 0.85 */
            padding: 5px 13.6px; /* 6px √ó 0.85, 16px √ó 0.85 */
            min-width: 85px; /* 100px √ó 0.85 */
        }
        
        .delivery-info {
            font-size: 0.808rem; /* 0.95rem √ó 0.85 */
        }
        
        .summary-cards-grid {
            grid-template-columns: 1fr;
            gap: 17px; /* 20px √ó 0.85 */
        }
        
        .summary-card {
            padding: 17px; /* 20px √ó 0.85 */
        }
        
        .summary-card h3 {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .summary-card h3 i {
            font-size: 0.85em !important;
        }
        
        .info-row {
            padding: 8.5px 0; /* 10px √ó 0.85 */
        }
        
        .info-label {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
            min-width: 119px; /* 140px √ó 0.85 */
        }
        
        .info-value {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .order-items-section {
            padding: 21.25px; /* 25px √ó 0.85 */
            margin-bottom: 25.5px; /* 30px √ó 0.85 */
        }
        
        .order-items-section h3 {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .order-items-section h3 i {
            font-size: 0.85em !important;
        }
        
        .order-items-list {
            gap: 12.75px; /* 15px √ó 0.85 */
        }
        
        .order-item-card {
            grid-template-columns: 68px 1fr auto; /* 80px √ó 0.85 */
            gap: 12.75px; /* 15px √ó 0.85 */
            padding: 12.75px; /* 15px √ó 0.85 */
        }
        
        .item-photo, .item-photo-placeholder {
            width: 68px !important; /* 80px √ó 0.85 */
            height: 68px !important; /* 80px √ó 0.85 */
        }
        
        .item-photo-placeholder i {
            font-size: 25.5px !important; /* 30px √ó 0.85 */
        }
        
        .item-name {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .item-description {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .item-meta span {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .item-meta i {
            font-size: 0.85em !important;
        }
        
        .item-total-container {
            min-width: 102px; /* 120px √ó 0.85 */
        }
        
        .item-total-amount {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .item-unit-price {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .btn {
            padding: 10.2px 20.4px; /* 12px √ó 0.85, 24px √ó 0.85 */
            font-size: 0.8075rem; /* 0.95rem √ó 0.85 */
            min-height: 37.4px; /* 44px √ó 0.85 */
        }
        
        .btn i {
            font-size: 0.85em !important;
        }
        
        .btn-text {
            font-size: 0.85em;
        }
        
        .order-timeline h4 {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .order-timeline h4 i {
            font-size: 0.85em !important;
        }
        
        .timeline {
            padding-left: 25.5px; /* 30px √ó 0.85 */
        }
        
        .timeline::before {
            left: 8.5px; /* 10px √ó 0.85 */
            width: 1.7px; /* 2px √ó 0.85 */
        }
        
        .timeline-content {
            padding: 8.5px 0; /* 10px √ó 0.85 */
        }
        
        .timeline-title {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .timeline-time {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .timeline-dot {
            width: 8.5px; /* 10px √ó 0.85 */
            height: 8.5px; /* 10px √ó 0.85 */
            left: -12.75px; /* -15px √ó 0.85 */
        }
        
        .item-type-badge {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
            padding: 2.55px 6.8px; /* 3px √ó 0.85, 8px √ó 0.85 */
        }
        
        .action-buttons {
            gap: 12.75px; /* 15px √ó 0.85 */
            margin-bottom: 25.5px; /* 30px √ó 0.85 */
        }
    }
    
    /* Small Mobile (375px - 575px) - 15% COMPRESSION -->
    @media (min-width: 375px) and (max-width: 575px) {
        .order-details-container {
            padding: 10px;
        }
        
        .order-header-card {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .order-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        /* 15% Font Size Reduction */
        .order-header-info h2 {
            font-size: 1.19rem; /* 1.4rem √ó 0.85 */
        }
        
        .order-date {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .order-status-badge {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
            padding: 4.25px 10.2px; /* 5px √ó 0.85, 12px √ó 0.85 */
            min-width: 68px; /* 80px √ó 0.85 */
        }
        
        .delivery-info {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .summary-cards-grid {
            grid-template-columns: 1fr;
            gap: 12.75px; /* 15px √ó 0.85 */
        }
        
        .summary-card {
            padding: 12.75px; /* 15px √ó 0.85 */
            border-radius: 8.5px; /* 10px √ó 0.85 */
        }
        
        .summary-card h3 {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .summary-card h3 i {
            font-size: 0.85em !important;
        }
        
        .info-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 3.4px; /* 4px √ó 0.85 */
            padding: 6.8px 0; /* 8px √ó 0.85 */
        }
        
        .info-label {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
            min-width: auto;
        }
        
        .info-value {
            font-size: 0.8075rem; /* 0.95rem √ó 0.85 */
        }
        
        .order-items-section {
            padding: 12.75px; /* 15px √ó 0.85 */
            border-radius: 8.5px; /* 10px √ó 0.85 */
        }
        
        .order-items-section h3 {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .order-items-section h3 i {
            font-size: 0.85em !important;
        }
        
        .order-item-card {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto;
            padding: 10.2px; /* 12px √ó 0.85 */
            gap: 10.2px; /* 12px √ó 0.85 */
            text-align: center;
        }
        
        .item-photo-container {
            grid-row: 1;
            justify-self: center;
        }
        
        .item-photo, .item-photo-placeholder {
            width: 85px !important; /* 100px √ó 0.85 */
            height: 85px !important; /* 100px √ó 0.85 */
        }
        
        .item-photo-placeholder i {
            font-size: 25.5px !important; /* 30px √ó 0.85 */
        }
        
        .item-details-container {
            grid-row: 2;
        }
        
        .item-header {
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .item-name {
            font-size: 0.8075rem; /* 0.95rem √ó 0.85 */
        }
        
        .item-description {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .item-meta {
            justify-content: center;
            flex-direction: column;
            gap: 4.25px; /* 5px √ó 0.85 */
        }
        
        .item-meta span {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .item-meta i {
            font-size: 0.85em !important;
        }
        
        .item-total-container {
            grid-row: 3;
            text-align: center;
            min-width: auto;
        }
        
        .item-total-amount {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .item-unit-price {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .item-actions {
            grid-row: 4;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
            padding: 10.2px 13.6px; /* 12px √ó 0.85, 16px √ó 0.85 */
            border-radius: 8.5px; /* 10px √ó 0.85 */
            font-size: 0.8075rem; /* 0.95rem √ó 0.85 */
            min-height: 37.4px; /* 44px √ó 0.85 */
        }
        
        .btn i {
            font-size: 0.935rem !important; /* 1.1rem √ó 0.85 */
        }
        
        .btn-text {
            font-size: 0.8075rem; /* 0.95rem √ó 0.85 */
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 6.8px; /* 8px √ó 0.85 */
        }
        
        .order-timeline h4 {
            font-size: 0.85rem; /* 1rem √ó 0.85 */
        }
        
        .order-timeline h4 i {
            font-size: 0.85em !important;
        }
        
        .timeline {
            padding-left: 17px; /* 20px √ó 0.85 */
        }
        
        .timeline::before {
            left: 6.8px; /* 8px √ó 0.85 */
        }
        
        .timeline-dot {
            left: -13.6px; /* -16px √ó 0.85 */
            width: 8.5px; /* 10px √ó 0.85 */
            height: 8.5px; /* 10px √ó 0.85 */
        }
        
        .timeline-content {
            padding: 10.2px; /* 12px √ó 0.85 */
        }
        
        .timeline-title {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .timeline-time {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
        }
        
        .item-type-badge {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
            padding: 2.55px 6.8px; /* 3px √ó 0.85, 8px √ó 0.85 */
        }
    }
    
    /* Extra Small Mobile (below 375px) - 15% COMPRESSION -->
    @media (max-width: 374px) {
        .order-details-container {
            padding: 6.8px; /* 8px √ó 0.85 */
        }
        
        .order-header-card {
            padding: 12.75px; /* 15px √ó 0.85 */
            border-radius: 10.2px; /* 12px √ó 0.85 */
            margin-bottom: 12.75px; /* 15px √ó 0.85 */
        }
        
        /* 15% Font Size Reduction */
        .order-header-info h2 {
            font-size: 1.105rem; /* 1.3rem √ó 0.85 */
        }
        
        .order-status-badge {
            font-size: 0.6375rem; /* 0.75rem √ó 0.85 */
            padding: 3.4px 8.5px; /* 4px √ó 0.85, 10px √ó 0.85 */
        }
        
        .btn {
            padding: 8.5px 10.2px; /* 10px √ó 0.85, 12px √ó 0.85 */
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
            min-height: 37.4px; /* 44px √ó 0.85 */
        }
        
        .btn-text {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .btn i {
            font-size: 0.85em !important;
        }
        
        .item-photo, .item-photo-placeholder {
            width: 68px !important; /* 80px √ó 0.85 */
            height: 68px !important; /* 80px √ó 0.85 */
        }
        
        .item-photo-placeholder i {
            font-size: 21.25px !important; /* 25px √ó 0.85 */
        }
        
        .item-name {
            font-size: 0.8075rem; /* 0.95rem √ó 0.85 */
        }
        
        .item-description {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
        }
        
        .timeline-content {
            padding: 8.5px; /* 10px √ó 0.85 */
        }
        
        .timeline-title {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .timeline-time {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
        }
        
        .timeline-dot {
            width: 7.65px; /* 9px √ó 0.85 */
            height: 7.65px; /* 9px √ó 0.85 */
        }
        
        .info-label {
            font-size: 0.7225rem; /* 0.85rem √ó 0.85 */
        }
        
        .info-value {
            font-size: 0.765rem; /* 0.9rem √ó 0.85 */
        }
        
        .item-type-badge {
            font-size: 0.68rem; /* 0.8rem √ó 0.85 */
            padding: 2.55px 5.95px; /* 3px √ó 0.85, 7px √ó 0.85 */
        }
        
        .summary-card h3 i {
            font-size: 0.85em !important;
        }
        
        .order-items-section h3 i {
            font-size: 0.85em !important;
        }
        
        .order-timeline h4 i {
            font-size: 0.85em !important;
        }
        
        .item-meta i {
            font-size: 0.85em !important;
        }
        
        .action-buttons .btn i {
            font-size: 0.85em !important;
        }
    }
    
    /* Print Styles -->
    @media print {
        .dashboard-header,
        .bottom-nav,
        .action-buttons,
        .item-actions,
        .order-timeline,
        .reorder-btn,
        .cancel-btn,
        .back-btn,
        .breadcrumb {
            display: none !important;
        }
        
        .order-details-container {
            padding: 0;
            margin: 0;
            max-width: none;
        }
        
        .order-header-card,
        .summary-card,
        .order-items-section,
        .order-actions-section {
            box-shadow: none;
            border: 1px solid #ddd;
            border-radius: 0;
            margin-bottom: 15px;
            page-break-inside: avoid;
        }
        
        .order-item-card {
            border: 1px solid #ddd;
            box-shadow: none;
            margin-bottom: 10px;
        }
        
        body {
            font-size: 12pt;
            line-height: 1.4;
        }
    }
</style>

<!-- JavaScript for Order Details -->
<script>
// Government Style Invoice Function - A4 FIXED VERSION
function generateGovernmentInvoice() {
    const orderId = '{{ order.order_id }}';
    const userId = '{{ session.get("user_id", "000") }}';
    const orderDateFormatted = '{{ order.order_date_formatted if order.order_date_formatted else "20250113" }}';
    const sessionId = '{{ session.get("session_id", "") }}';
    const ipAddress = '{{ request.remote_addr|default("0.0.0.0") }}';
    
    // Show loading
    const printBtn = document.querySelector('.print-btn');
    const originalHTML = printBtn.innerHTML;
    printBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Official Invoice...';
    printBtn.disabled = true;
    
    // Get current date and time
    const now = new Date();
    const currentDate = now.toLocaleDateString('en-IN', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Calculate taxes (5% service tax + 12% GST = 17% total tax)
    const subtotal = parseFloat('{{ order.total_amount|float }}');
    const serviceTax = subtotal * 0.05;
    const gst = subtotal * 0.12;
    const grandTotal = subtotal + serviceTax + gst;
    
    // Format currency
    const formatCurrency = (amount) => {
        return '‚Çπ' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    };
    
    // Create timestamp
    const timestamp = now.getTime();
    const dateStr = now.toISOString().slice(0,19).replace(/[-:]/g, '');
    
    // Get order date first 8 characters
    const orderDateFirst8 = orderDateFormatted.replace(/-/g, '').slice(0,8) || '20250113';
    
    // Create Government Style Invoice HTML with A4 PERFECT FIT
    const invoiceHTML = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Official Invoice #${orderId}</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Source+Code+Pro&display=swap" rel="stylesheet">
        <style>
            /* A4 Paper Dimensions: 210mm √ó 297mm */
            @page {
                size: A4;
                margin: 10mm; /* Reduced margins for more content space */
            }
            
            /* Base Styles for A4 */
            body {
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 0;
                color: #1a1a1a;
                line-height: 1.4;
                background: #fff;
                width: 210mm;
                min-height: 297mm;
                position: relative;
                box-sizing: border-box;
                font-size: 11px !important; /* Reduced font size */
            }
            
            /* A4 Container */
            .a4-container {
                width: 100%;
                min-height: 277mm; /* 297mm - 10mm top - 10mm bottom */
                padding: 5mm;
                box-sizing: border-box;
                position: relative;
            }
            
            /* Watermark - Smaller for A4 */
            .watermark {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 80px; /* Reduced from 120px */
                color: rgba(0, 0, 0, 0.03);
                font-weight: 900;
                z-index: -1;
                letter-spacing: 15px; /* Reduced spacing */
                text-transform: uppercase;
                font-family: 'Playfair Display', serif;
                white-space: nowrap;
            }
            
            /* Security Border - Compact */
            .security-border {
                border: 2px double #8b0000;
                padding: 2px;
                position: relative;
                margin: 0;
                min-height: 275mm;
            }
            
            .security-border::before {
                content: "‚ñà ‚ñà ‚ñà GOVERNMENT DOCUMENT ‚ñà ‚ñà ‚ñà";
                position: absolute;
                top: -10px;
                left: 50%;
                transform: translateX(-50%);
                background: #fff;
                padding: 2px 15px;
                color: #8b0000;
                font-size: 8px;
                letter-spacing: 2px;
                font-weight: 900;
                font-family: 'Source Code Pro', monospace;
                border: 1px solid #8b0000;
                border-radius: 2px;
            }
            
            /* Holographic Strip - Thinner */
            .holographic-strip {
                height: 3px;
                background: linear-gradient(90deg, 
                    #ff0000 0%, #ff9900 20%, #ffff00 40%, 
                    #00ff00 60%, #0099ff 80%, #6600ff 100%);
                margin: 10px 0;
                border-radius: 2px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
            
            /* Serial Number - Compact */
            .serial-number {
                font-family: 'Courier New', monospace;
                letter-spacing: 2px;
                background: linear-gradient(45deg, #000 0%, #333 100%);
                color: #ffd700;
                padding: 5px 15px;
                display: inline-block;
                margin: 10px 0;
                border: 1px solid #8b0000;
                border-radius: 3px;
                font-weight: bold;
                font-size: 11px;
                text-shadow: 0 1px 1px rgba(0,0,0,0.5);
            }
            
            /* Government Header - Compact */
            .government-header {
                text-align: center;
                border: 2px double #000;
                padding: 10px;
                margin: 15px 10px;
                position: relative;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 5px;
            }
            
            .government-header h1 {
                margin: 0 0 5px 0;
                color: #1a237e;
                font-size: 18px; /* Reduced */
                font-family: 'Playfair Display', serif;
            }
            
            .government-header h2 {
                margin: 0 0 10px 0;
                color: #8b0000;
                font-size: 16px; /* Reduced */
                font-weight: 700;
            }
            
            .government-header p {
                margin: 3px 0;
                font-size: 10px; /* Reduced */
            }
            
            /* Invoice Container - Compact */
            .invoice-container {
                padding: 0 15px;
                box-sizing: border-box;
            }
            
            /* Section Titles - Smaller */
            .section-title {
                font-family: 'Playfair Display', serif;
                color: #1a237e;
                border-bottom: 2px solid #1a237e;
                padding-bottom: 5px;
                margin: 15px 0 10px 0;
                font-size: 14px;
                position: relative;
            }
            
            .section-title::after {
                content: "";
                position: absolute;
                bottom: -2px;
                left: 0;
                width: 60px;
                height: 2px;
                background: #8b0000;
            }
            
            /* Info Grid - 2 columns with reduced gap */
            .info-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 15px;
            }
            
            /* Info Cards - Compact */
            .info-card {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 5px;
                padding: 12px;
                position: relative;
                overflow: hidden;
                font-size: 10px;
            }
            
            .info-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(to bottom, #1a237e, #8b0000);
            }
            
            .info-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 6px;
                padding-bottom: 5px;
                border-bottom: 1px dashed #cbd5e1;
                font-size: 10px;
                line-height: 1.2;
            }
            
            .info-label {
                color: #475569;
                font-weight: 600;
                min-width: 110px; /* Reduced */
                font-size: 9.5px;
            }
            
            .info-value {
                color: #1e293b;
                font-weight: 500;
                text-align: right;
                flex: 1;
                font-size: 9.5px;
            }
            
            /* Session Data - Compact */
            .session-data-card {
                background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
                border: 1px solid #0ea5e9;
                border-radius: 5px;
                padding: 12px;
                margin: 15px 0;
                position: relative;
                font-size: 10px;
            }
            
            .session-data-card::before {
                content: "üîê SESSION DATA";
                position: absolute;
                top: -8px;
                left: 15px;
                background: #0ea5e9;
                color: white;
                padding: 2px 12px;
                border-radius: 3px;
                font-size: 9px;
                font-weight: bold;
                letter-spacing: 1px;
            }
            
            .session-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-top: 10px;
            }
            
            .session-item {
                display: flex;
                flex-direction: column;
                padding: 6px;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 4px;
                border-left: 3px solid #0ea5e9;
                font-size: 9px;
            }
            
            .session-label {
                font-size: 8.5px;
                color: #475569;
                font-weight: 600;
                margin-bottom: 2px;
            }
            
            .session-value {
                font-size: 9px;
                color: #1e293b;
                font-weight: 500;
                word-break: break-all;
                font-family: 'Courier New', monospace;
            }
            
            /* Items Table - Compact */
            .items-table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
                font-size: 9.5px;
                table-layout: fixed; /* Fixed layout for better control */
            }
            
            .items-table th {
                background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
                color: white;
                padding: 8px 10px;
                text-align: left;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border: none;
                position: relative;
                font-size: 9px;
            }
            
            .items-table th::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 2px;
                background: linear-gradient(90deg, #ffd700, #ff6b6b);
            }
            
            .items-table td {
                padding: 6px 8px;
                border-bottom: 1px solid #e2e8f0;
                vertical-align: top;
                font-size: 9.5px;
                word-wrap: break-word;
            }
            
            /* Fixed column widths for table */
            .items-table th:nth-child(1),
            .items-table td:nth-child(1) {
                width: 35%; /* Item Description */
            }
            
            .items-table th:nth-child(2),
            .items-table td:nth-child(2) {
                width: 12%; /* Type */
            }
            
            .items-table th:nth-child(3),
            .items-table td:nth-child(3) {
                width: 12%; /* Quantity */
                text-align: center;
            }
            
            .items-table th:nth-child(4),
            .items-table td:nth-child(4) {
                width: 18%; /* Unit Price */
                text-align: right;
            }
            
            .items-table th:nth-child(5),
            .items-table td:nth-child(5) {
                width: 23%; /* Total */
                text-align: right;
            }
            
            .items-table tr:nth-child(even) {
                background: #f8fafc;
            }
            
            /* Total Section - Compact */
            .total-section {
                text-align: right;
                margin: 20px 0;
                padding: 15px;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border-radius: 6px;
                border: 1px solid #cbd5e1;
                font-size: 10px;
            }
            
            .total-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                padding: 5px 0;
                border-bottom: 1px dashed #cbd5e1;
                font-size: 10px;
            }
            
            .total-label {
                color: #475569;
                font-weight: 600;
                font-size: 10px;
            }
            
            .total-value {
                color: #1e293b;
                font-weight: 600;
                min-width: 100px;
                text-align: right;
                font-size: 10px;
            }
            
            .grand-total {
                font-size: 16px;
                color: #059669;
                font-weight: 700;
                padding-top: 10px;
                border-top: 2px solid #059669;
                margin-top: 10px;
            }
            
            /* Government Seal - Smaller */
            .government-seal-section {
                text-align: center;
                margin: 20px 0;
                padding: 15px 0;
                border-top: 2px dashed #cbd5e1;
                border-bottom: 2px dashed #cbd5e1;
            }
            
            .seal-container {
                display: inline-block;
                position: relative;
                padding: 10px;
            }
            
            .seal-outer {
                width: 120px;
                height: 120px;
                border: 3px solid #8b0000;
                border-radius: 50%;
                position: relative;
                background: radial-gradient(circle, #fff 0%, #f8f9fa 100%);
                box-shadow: 0 0 10px rgba(139, 0, 0, 0.2);
            }
            
            .seal-inner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                width: 100px;
            }
            
            .seal-text {
                font-family: 'Playfair Display', serif;
                font-weight: 700;
                color: #8b0000;
                font-size: 11px;
                line-height: 1.2;
                text-transform: uppercase;
            }
            
            .seal-text-small {
                font-size: 8px;
                margin-top: 3px;
                color: #475569;
            }
            
            /* Security Features - Compact */
            .security-features {
                font-size: 7px;
                color: #64748b;
                text-align: center;
                margin: 15px 0;
                padding: 10px;
                background: #f8fafc;
                border-radius: 4px;
                border: 1px solid #e2e8f0;
                font-family: 'Source Code Pro', monospace;
                line-height: 1.2;
            }
            
            .micro-text {
                font-size: 5.5px;
                color: #475569;
                text-align: justify;
                line-height: 1.1;
                margin: 10px 0;
                padding: 8px;
                background: #f1f5f9;
                border-radius: 3px;
                border: 1px solid #cbd5e1;
                font-family: 'Courier New', monospace;
            }
            
            /* QR Code - Smaller */
            .qr-code-box {
                text-align: center;
                padding: 15px;
                border: 1px solid #cbd5e1;
                border-radius: 5px;
                margin: 15px auto;
                width: 150px;
                background: white;
            }
            
            .qr-code-box div {
                font-family: monospace;
                font-size: 8px;
                margin-bottom: 8px;
                line-height: 1.1;
            }
            
            /* Signature Section - Compact */
            .signature-section {
                display: flex;
                justify-content: space-between;
                margin: 25px 0;
                padding-top: 15px;
                border-top: 2px solid #1a237e;
            }
            
            .signature-box {
                text-align: center;
                padding: 10px;
                min-width: 150px;
            }
            
            .signature-line {
                width: 120px;
                height: 1px;
                background: #000;
                margin: 25px auto 8px;
            }
            
            .signature-text {
                font-weight: 600;
                color: #1a237e;
                margin-top: 3px;
                font-size: 11px;
            }
            
            .stamp-container {
                border: 2px solid #8b0000;
                padding: 8px;
                display: inline-block;
                transform: rotate(5deg);
                background: white;
                box-shadow: 0 0 8px rgba(0,0,0,0.1);
            }
            
            .stamp-text {
                font-weight: 700;
                color: #8b0000;
                font-size: 14px;
                text-align: center;
            }
            
            /* Invoice Footer - Compact */
            .invoice-footer {
                text-align: center;
                margin-top: 25px;
                padding-top: 15px;
                border-top: 1px solid #cbd5e1;
                font-size: 9px;
                color: #64748b;
                line-height: 1.3;
            }
            
            /* Print Optimization */
            @media print {
                body {
                    width: 210mm;
                    height: 297mm;
                    margin: 0;
                    padding: 0;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                .a4-container {
                    width: 100%;
                    min-height: 100%;
                    padding: 5mm;
                }
                
                .security-border {
                    border: 2px double #8b0000;
                    margin: 0;
                    padding: 2px;
                    min-height: 285mm;
                }
                
                .watermark {
                    opacity: 0.02;
                }
                
                /* Prevent page breaks inside important sections */
                .info-grid,
                .session-data-card,
                .total-section,
                .government-seal-section,
                .signature-section {
                    page-break-inside: avoid;
                }
                
                /* Adjust table for printing */
                .items-table {
                    page-break-inside: auto;
                }
                
                .items-table tr {
                    page-break-inside: avoid;
                    page-break-after: auto;
                }
            }
            
            /* Adjust font sizes for better fit */
            small {
                font-size: 8.5px !important;
            }
            
            /* Status badges - smaller */
            .status-badge {
                padding: 2px 6px !important;
                border-radius: 8px !important;
                font-size: 8px !important;
                font-weight: 600 !important;
            }
            
            /* Ensure everything fits in A4 */
            .no-overflow {
                overflow: hidden;
                max-width: 100%;
            }
        </style>
    </head>
    <body>
        <!-- Security Watermark -->
        <div class="watermark">OFFICIAL INVOICE</div>
        
        <!-- A4 Container -->
        <div class="a4-container">
            <!-- Security Border -->
            <div class="security-border">
                <!-- Holographic Strip -->
                <div class="holographic-strip"></div>
                
                <!-- Unique Serial Number -->
                <div style="text-align: center;">
                    <div class="serial-number">
                        INVOICE-${orderId}-${userId}-${subtotal.toFixed(6)}
                    </div>
                </div>
                
                <!-- Government Header -->
                <div class="government-header">
                    <h1>GOVERNMENT OF INDIA RECOGNIZED</h1>
                    <h2>BITE ME BUDDY FOOD SERVICES</h2>
                    <p>
                        <strong>FSSAI License No:</strong> 12345678901234 | 
                        <strong>GSTIN:</strong> 09AABCU9603R1ZX | 
                        <strong>PAN:</strong> AABCU9603R
                    </p>
                    <p style="color: #475569;">
                        Varanasi Ghats, Uttar Pradesh, India | Phone: +91 7275726604 | Email: info@bitemebuddy.com
                    </p>
                </div>
                
                <!-- Main Invoice Container -->
                <div class="invoice-container">
                    
                    <!-- Order Information Section -->
                    <div class="section-title">ORDER INFORMATION</div>
                    
                    <div class="info-grid">
                        <!-- Order Details Card -->
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">Invoice Number:</span>
                                <span class="info-value" style="color: #1a237e; font-weight: 700;">${orderId}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Order Date:</span>
                                <span class="info-value">${'{{ order.order_date_formatted or order.order_date or "N/A" }}'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Order Status:</span>
                                <span class="info-value">
                                    <span class="status-badge" style="background: #d1fae5; color: #065f46;">
                                        ${'{{ order.status|title if order.status else "Pending" }}'}
                                    </span>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Payment Mode:</span>
                                <span class="info-value">${'{{ order.payment_mode|default("Cash on Delivery")|title }}'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Payment Status:</span>
                                <span class="info-value">
                                    <span class="status-badge" style="background: #fef3c7; color: #92400e;">
                                        ${'{{ order.payment_status|default("Pending")|title }}'}
                                    </span>
                                </span>
                            </div>
                            ${'{% if order.transaction_id %}'}
                            <div class="info-row">
                                <span class="info-label">Transaction ID:</span>
                                <span class="info-value" style="font-family: 'Courier New', monospace;">${'{{ order.transaction_id }}'}</span>
                            </div>
                            ${'{% endif %}'}
                            <div class="info-row">
                                <span class="info-label">Delivery Location:</span>
                                <span class="info-value">${'{{ order.delivery_location|default("Not specified") }}'}</span>
                            </div>
                        </div>
                        
                        <!-- Customer Information Card -->
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">Customer Name:</span>
                                <span class="info-value" style="font-weight: 600;">${'{{ session.get("full_name", order.user_name or "Customer")|e }}'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Customer ID:</span>
                                <span class="info-value" style="font-family: 'Courier New', monospace;">UID-${'{{ session.get("user_id", "000") }}'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email Address:</span>
                                <span class="info-value">${'{{ session.get("email", order.user_email or "N/A")|e }}'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone Number:</span>
                                <span class="info-value">${'{{ session.get("phone", order.user_phone or "N/A")|e }}'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Delivery Address:</span>
                                <span class="info-value">${'{{ session.get("location", order.user_address or "Address not specified")|e }}'}</span>
                            </div>
                            ${'{% if order.notes %}'}
                            <div class="info-row">
                                <span class="info-label">Order Notes:</span>
                                <span class="info-value">${'{{ order.notes }}'}</span>
                            </div>
                            ${'{% endif %}'}
                        </div>
                    </div>
                    
                    <!-- Secure Session Data Section -->
                    <div class="section-title">SECURE SESSION VERIFICATION</div>
                    
                    <div class="session-data-card">
                        <div class="session-grid">
                            <!-- User Session Info -->
                            <div class="session-item">
                                <span class="session-label">Session ID:</span>
                                <span class="session-value">${sessionId.substring(0, 12)}***</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">User ID:</span>
                                <span class="session-value">${userId}</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Account Type:</span>
                                <span class="session-value">${'{{ session.get("account_type", "Customer")|e|title }}'}</span>
                            </div>
                            
                            <!-- Device & Browser Info -->
                            <div class="session-item">
                                <span class="session-label">IP Address:</span>
                                <span class="session-value">${ipAddress}</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Device Type:</span>
                                <span class="session-value">
                                    ${'{% if request.user_agent %}'}
                                        ${'{% if "Mobile" in request.user_agent.string %}'}üì± Mobile
                                        ${'{% elif "Tablet" in request.user_agent.string %}'}üì± Tablet
                                        ${'{% else %}'}üíª Desktop${'{% endif %}'}
                                    ${'{% else %}'}N/A${'{% endif %}'}
                                </span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Browser:</span>
                                <span class="session-value">
                                    ${'{{ request.user_agent.browser|default("N/A")|e }}'} ${'{{ request.user_agent.version|default("")|e }}'}
                                </span>
                            </div>
                            
                            <!-- Additional Session Data -->
                            <div class="session-item">
                                <span class="session-label">Platform:</span>
                                <span class="session-value">${'{{ request.user_agent.platform|default("N/A")|e }}'}</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Language:</span>
                                <span class="session-value">${'{{ request.accept_languages.best|default("en-IN")|e }}'}</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Session Status:</span>
                                <span class="session-value">
                                    ${'{% if session.get("is_active") %}'}
                                        <span style="color: #059669;">‚óè Active</span>
                                    ${'{% else %}'}
                                        <span style="color: #dc2626;">‚óè Inactive</span>
                                    ${'{% endif %}'}
                                </span>
                            </div>
                            
                            <!-- User Stats -->
                            <div class="session-item">
                                <span class="session-label">Account Created:</span>
                                <span class="session-value">${'{{ session.get("created_at", "N/A")|e }}'}</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Total Orders:</span>
                                <span class="session-value">${'{{ session.get("order_count", "1")|e }}'}</span>
                            </div>
                            
                            <div class="session-item">
                                <span class="session-label">Loyalty Points:</span>
                                <span class="session-value">${'{{ session.get("loyalty_points", "0")|e }}'}</span>
                            </div>
                        </div>
                        
                        <!-- Encrypted Note -->
                        <div style="text-align: center; margin-top: 10px; padding: 8px; background: rgba(14, 165, 233, 0.1); border-radius: 3px;">
                            <p style="margin: 0; font-size: 8.5px; color: #0369a1; font-weight: 600;">
                                üîê This session data is securely encrypted and transmitted over HTTPS. 
                                Used for verification purposes only.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Order Items Section -->
                    <div class="section-title">ORDER ITEMS DETAIL</div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Item Description</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Unit Price (‚Çπ)</th>
                                <th>Total (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${'{% if items and items|length > 0 %}'}
                                ${'{% for item in items %}'}
                                <tr>
                                    <td>
                                        <strong>${'{{ item.name }}'}</strong>
                                        ${'{% if item.description %}'}
                                        <br><small>${'{{ item.description }}'}</small>
                                        ${'{% endif %}'}
                                    </td>
                                    <td>
                                        <span style="padding: 2px 5px; background: ${'{% if item.type|lower == "service" %}'}#dbeafe${'{% else %}'}#dcfce7${'{% endif %}'}; 
                                              color: ${'{% if item.type|lower == "service" %}'}#1e40af${'{% else %}'}#166534${'{% endif %}'}; 
                                              border-radius: 8px; font-size: 8px; font-weight: 600;">
                                            ${'{{ item.type|default("Menu")|title }}'}
                                        </span>
                                    </td>
                                    <td>${'{{ item.quantity }}'}</td>
                                    <td>‚Çπ${'{{ "%.2f"|format(item.price|float) }}'}</td>
                                    <td><strong>‚Çπ${'{{ "%.2f"|format(item.price|float * item.quantity) }}'}</strong></td>
                                </tr>
                                ${'{% endfor %}'}
                            ${'{% else %}'}
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px; color: #64748b;">
                                        No items found for this order
                                    </td>
                                </tr>
                            ${'{% endif %}'}
                        </tbody>
                    </table>
                    
                    <!-- Payment Summary -->
                    <div class="total-section">
                        <div class="total-row">
                            <span class="total-label">Subtotal:</span>
                            <span class="total-value">${formatCurrency(subtotal)}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">Delivery Charges:</span>
                            <span class="total-value">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">Service Tax (5%):</span>
                            <span class="total-value">${formatCurrency(serviceTax)}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">GST (12%):</span>
                            <span class="total-value">${formatCurrency(gst)}</span>
                        </div>
                        <div class="total-row grand-total">
                            <span class="total-label">Grand Total:</span>
                            <span class="total-value">${formatCurrency(grandTotal)}</span>
                        </div>
                    </div>
                    
                    <!-- Government Seal -->
                    <div class="government-seal-section">
                        <div class="seal-container">
                            <div class="seal-outer">
                                <div class="seal-inner">
                                    <div class="seal-text">OFFICIAL RECEIPT</div>
                                    <div class="seal-text">BITE ME BUDDY</div>
                                    <div class="seal-text-small">Invoice No: ${orderId}</div>
                                    <div class="seal-text-small">Date: ${'{{ order.order_date_formatted[:10] if order.order_date_formatted else "" }}'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Features -->
                    <div class="security-features">
                        <strong>DOCUMENT SECURITY FEATURES:</strong> 
                        UNIQUE SERIAL NUMBER | HOLOGRAPHIC STRIP | MICRO-TEXT | 
                        UV REACTIVE INK | ANTI-COPY PATTERN | DIGITAL SIGNATURE
                    </div>
                    
                    <!-- Micro Text -->
                    <div class="micro-text">
                        OFFICIAL DOCUMENT ISSUED BY BITE ME BUDDY FOOD SERVICES UNDER GOVERNMENT OF INDIA RECOGNITION. FSSAI LICENSE: 12345678901234. GSTIN: 09AABCU9603R1ZX. THIS DOCUMENT CONTAINS SECURITY FEATURES THAT ARE VISIBLE UNDER UV LIGHT AND WILL NOT REPRODUCE CLEARLY WHEN COPIED. ANY UNAUTHORIZED REPRODUCTION, ALTERATION, OR FORGERY OF THIS DOCUMENT IS PUNISHABLE UNDER SECTIONS 463, 464, AND 465 OF THE INDIAN PENAL CODE, 1860. DOCUMENT SERIAL: ${orderId}${userId}${orderDateFirst8} SECURITY CODE: BMBSEC${subtotal.toFixed(0).padStart(6, '0')} SESSION: ${sessionId.substring(0, 8).toUpperCase()} IP HASH: ${ipAddress.replace(/\./g, '').substring(0, 12)} VERIFICATION TIMESTAMP: ${dateStr}
                    </div>
                    
                    <!-- QR Code -->
                    <div class="qr-code-box">
                        <div>
                            ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë<br>
                            ‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë ‚ñë ‚ñë‚ñë‚ñë ‚ñë‚ñë ‚ñë‚ñë‚ñë<br>
                            ‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë<br>
                            ‚ñë‚ñë ‚ñë ‚ñë‚ñë‚ñë‚ñë ‚ñë ‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë<br>
                            ‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë<br>
                            ‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë ‚ñë ‚ñë‚ñë‚ñë ‚ñë‚ñë ‚ñë‚ñë‚ñë<br>
                            ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
                        </div>
                        <p style="margin: 3px 0; color: #475569;">
                            <strong>VERIFICATION QR CODE</strong><br>
                            Scan to verify authenticity
                        </p>
                        <p style="color: #64748b; margin-top: 5px;">
                            verify.bmb.gov.in/${orderId}
                        </p>
                    </div>
                    
                    <!-- Signature Section -->
                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-text">Customer Signature/Stamp</div>
                            <p style="font-size: 8.5px; color: #64748b; margin-top: 3px;">
                                ${'{{ session.get("full_name", "Customer")|e }}'}<br>
                                UID: ${'{{ session.get("user_id", "000") }}'}
                            </p>
                        </div>
                        
                        <div class="signature-box">
                            <div class="stamp-container">
                                <div class="stamp-text">PAID</div>
                                <div style="font-size: 8.5px; color: #8b0000; margin-top: 3px;">
                                    ${'{{ order.order_date_formatted[:10] if order.order_date_formatted else "" }}'}
                                </div>
                            </div>
                            <div class="signature-text">Official Receipt Stamp</div>
                            <p style="font-size: 8.5px; color: #64748b; margin-top: 3px;">
                                Bite Me Buddy Food Services
                            </p>
                        </div>
                        
                        <div class="signature-box">
                            <div style="font-family: 'Brush Script MT', cursive; font-size: 18px; color: #1a237e; margin: 20px 0 5px;">
                                Signature
                            </div>
                            <div class="signature-text">Authorized Signatory</div>
                            <p style="font-size: 8.5px; color: #64748b; margin-top: 3px;">
                                Digital Signature under IT Act, 2000<br>
                                FSSAI Certified
                            </p>
                        </div>
                    </div>
                    
                    <!-- Invoice Footer -->
                    <div class="invoice-footer">
                        <p>
                            <strong>BITE ME BUDDY FOOD SERVICES</strong><br>
                            Varanasi Ghats, Uttar Pradesh, India | Phone: +91 7275726604 | Email: info@bitemebuddy.com<br>
                            Website: https://bitemebuddy.com | FSSAI License No: 12345678901234 | GSTIN: 09AABCU9603R1ZX
                        </p>
                        <p style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                            This is a computer generated invoice and does not require physical signature. Valid as per the Information Technology Act, 2000.<br>
                            Invoice generated on: ${currentDate} | 
                            Session: ${sessionId.substring(0, 12)} | 
                            Document ID: INV-${orderId}-${userId}-${dateStr}
                        </p>
                        <p style="color: #94a3b8; margin-top: 10px;">
                            Thank you for choosing Bite Me Buddy! For any queries, please contact our customer support.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
    
    // Create a Blob and download
    const blob = new Blob([invoiceHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Official_Invoice_${orderId}_${now.toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Restore button
    setTimeout(() => {
        printBtn.innerHTML = originalHTML;
        printBtn.disabled = false;
        
        // Show success message
        showNotification('Official invoice downloaded successfully!', 'success');
    }, 2000);
}

// Show notification function
function showNotification(message, type = 'success') {
    // Remove existing notification
    const existingNotification = document.querySelector('.invoice-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `invoice-notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Add styles
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
    `;
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Cancel Order Function
function cancelOrder(orderId) {
    if(confirm('Are you sure you want to cancel this order?')) {
        fetch(`/cancel-order/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: 'User requested cancellation' })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                showNotification('Order cancelled successfully!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showNotification('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Error cancelling order: ' + error, 'error');
        });
    }
}

// Reorder Item Function
function reorderItem(itemType, itemId) {
    if(confirm('Add this item to cart?')) {
        fetch('/add_to_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `item_type=${itemType}&item_id=${itemId}&quantity=1`
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                showNotification('Item added to cart!', 'success');
                setTimeout(() => {
                    window.location.href = '/cart';
                }, 1500);
            } else {
                showNotification('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('Error: ' + error, 'error');
        });
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Order details page loaded');
    console.log('Order ID: {{ order.order_id }}');
    console.log('Items count: {{ items|length }}');
    
    // Add event listeners for buttons
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            cancelOrder(orderId);
        });
    });
    
    document.querySelectorAll('.reorder-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemType = this.getAttribute('data-item-type');
            const itemId = this.getAttribute('data-item-id');
            reorderItem(itemType, itemId);
        });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + P to download PDF
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            generateGovernmentInvoice();
        }
        // Escape to go back
        if (e.key === 'Escape') {
            window.history.back();
        }
        // Ctrl + D to download invoice
        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            generateGovernmentInvoice();
        }
    });
    
    // Handle window resize for responsive design
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            console.log('Window resized to:', window.innerWidth, 'x', window.innerHeight);
        }, 250);
    });
    
    // Add touch support for mobile
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
        
        // Increase button hit area on mobile
        document.querySelectorAll('.btn').forEach(btn => {
            btn.style.minHeight = '44px';
        });
    }
    
    // Add loading animation to print button
    const printBtn = document.querySelector('.print-btn');
    if (printBtn) {
        printBtn.addEventListener('click', function(e) {
            if (!this.disabled) {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing Invoice...';
                this.disabled = true;
                
                // Re-enable after 5 seconds if something goes wrong
                setTimeout(() => {
                    if (this.disabled) {
                        this.innerHTML = '<i class="fas fa-file-invoice"></i> <span class="btn-text">Download Official Invoice</span>';
                        this.disabled = false;
                    }
                }, 5000);
            }
        });
    }
});
</script>

<!-- Add Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}
