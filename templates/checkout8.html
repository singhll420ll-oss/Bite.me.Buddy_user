<!-- checkout.html - COMPLETE VERSION WITH LOCATION FUNCTION -->
{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Top Header - Original Version -->
    <header class="dashboard-header">
        <div class="header-left">
            <h1>Checkout</h1>
            <p class="welcome-text">Review your order</p>
        </div>
        <div class="header-right">
            <img src="{{ session.profile_pic }}" 
                 alt="Profile" class="profile-pic"
                 onerror="this.src='{{ url_for('static', filename='default-avatar.jpg') }}'">
        </div>
    </header>

    <main class="main-content">
        <div class="checkout-container">
            <!-- Order Items Section -->
            <div class="checkout-section">
                <h2><i class="fas fa-shopping-cart"></i> Order Items ({{ cart_items|length }})</h2>
                
                {% if cart_items and cart_items|length > 0 %}
                <div class="cart-items-list">
                    {% for item in cart_items %}
                    <div class="cart-item-card">
                        {% if item.details.photo %}
                        <img src="{{ item.details.photo }}" 
                             alt="{{ item.details.name }}" 
                             class="item-photo"
                             onerror="this.src='{{ url_for('static', filename='default-item.jpg') }}'">
                        {% else %}
                        <div class="item-photo-placeholder">
                            <i class="fas fa-{{ 'concierge-bell' if item.type == 'service' else 'utensils' }}"></i>
                        </div>
                        {% endif %}
                        
                        <div class="item-details">
                            <h4>{{ item.details.name }}</h4>
                            <p class="item-description">{{ item.details.description|default('No description available') }}</p>
                            <div class="item-meta">
                                <span class="item-type {{ item.type }}">{{ item.type|title }}</span>
                                <span class="item-quantity">Qty: {{ item.quantity }}</span>
                            </div>
                        </div>
                        
                        <div class="item-pricing">
                            <div class="item-price">‚Çπ{{ "%.2f"|format(item.details.price) }}</div>
                            <div class="item-total">‚Çπ{{ "%.2f"|format(item.item_total) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>‚Çπ{{ "%.2f"|format(cart_total) }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Charge</span>
                        <span>‚Çπ0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span><strong>Total Amount</strong></span>
                        <span><strong>‚Çπ{{ "%.2f"|format(cart_total) }}</strong></span>
                    </div>
                </div>
                {% else %}
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart fa-3x"></i>
                    <h3>Your cart is empty</h3>
                    <p>Add items to cart before checkout</p>
                    <a href="{{ url_for('services') }}" class="btn btn-primary">
                        <i class="fas fa-concierge-bell"></i> Browse Services
                    </a>
                    <a href="{{ url_for('menu') }}" class="btn btn-primary">
                        <i class="fas fa-utensils"></i> Browse Menu
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Checkout Form with Location Function -->
            {% if cart_items and cart_items|length > 0 %}
            <div class="checkout-section">
                <h2><i class="fas fa-credit-card"></i> Payment & Delivery</h2>
                <form method="POST" action="{{ url_for('checkout') }}" class="checkout-form">
                    <!-- Delivery Location with Get Current Location Button -->
                    <div class="form-group">
                        <label for="delivery_location">
                            <i class="fas fa-map-marker-alt"></i> Delivery Address
                        </label>
                        <div class="location-input">
                            <textarea id="delivery_location" name="delivery_location" 
                                      class="form-control" rows="3" required
                                      placeholder="Enter complete delivery address with village/city, area and pincode">{{ session.location }}</textarea>
                            <button type="button" class="location-btn" id="locationBtn">  
                                <i class="fas fa-map-marker-alt"></i> 
                                <span>Get Current Location</span>
                            </button>
                        </div>
                        <small id="locationHelp" class="help-text"></small>
                        <!-- Hidden field for combined location data -->
                        <input type="hidden" id="location_combined" name="location_combined">
                    </div>
                    
                    <!-- Payment Mode -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-money-bill-wave"></i> Payment Method
                        </label>
                        <div class="payment-options">
                            <label class="payment-option">
                                <input type="radio" name="payment_mode" value="COD" checked>
                                <div class="option-content">
                                    <i class="fas fa-money-bill"></i>
                                    <span>Cash on Delivery (COD)</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="payment_mode" value="UPI">
                                <div class="option-content">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span>UPI / PhonePe / GPay</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="payment_mode" value="Card">
                                <div class="option-content">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Credit/Debit Card</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Terms & Submit -->
                    <div class="form-group terms">
                        <label>
                            <input type="checkbox" required>
                            I agree to the terms and conditions
                        </label>
                    </div>
                    
                    <div class="checkout-actions">
                        <a href="{{ url_for('cart') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Cart
                        </a>
                        <button type="submit" class="btn btn-success btn-confirm">
                            <i class="fas fa-check-circle"></i> Confirm Order (‚Çπ{{ "%.2f"|format(cart_total) }})
                        </button>
                    </div>
                </form>
                
                <!-- User Details Section - Moved below Confirm Order -->
                <div class="user-details-section" style="margin-top: 30px;">
                    <h2><i class="fas fa-user-circle"></i> Your Details</h2>
                    <div class="user-details-card">
                        <div class="detail-row">
                            <span class="detail-label">Full Name:</span>
                            <span class="detail-value">{{ session.full_name }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">{{ session.email }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mobile:</span>
                            <span class="detail-value">{{ session.phone }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Address:</span>
                            <span class="detail-value">{{ session.location }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Bottom Navigation - Original Version -->
    <nav class="bottom-nav">
        <a href="{{ url_for('services') }}" class="nav-item">
            <i class="fas fa-concierge-bell"></i>
            <span>Services</span>
        </a>
        <a href="{{ url_for('menu') }}" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="{{ url_for('cart') }}" class="nav-item">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="{{ url_for('order_history') }}" class="nav-item">
            <i class="fas fa-history"></i>
            <span>Orders</span>
        </a>
        <a href="{{ url_for('profile') }}" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>
</div>

<!-- Checkout Styles with Mobile Optimization -->
<style>
.checkout-container {
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 70px; /* Space for bottom nav */
}

.checkout-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #eaeaea;
}

/* User Details Section - inside checkout-section */
.user-details-section {
    border-top: 2px solid #f0f0f0;
    padding-top: 25px;
    margin-top: 30px;
}

.user-details-section h2 {
    color: #333;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.35rem;
}

.user-details-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.9rem;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: #6c757d;
    font-weight: 500;
    font-size: 0.855rem;
    min-width: 90px;
}

.detail-value {
    color: #212529;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: right;
    flex: 1;
    margin-left: 15px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Rest of the sections */
.checkout-section h2 {
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.5rem;
}

.cart-items-list {
    margin: 20px 0;
}

.cart-item-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    background: #fff;
}

.item-photo {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
}

.item-photo-placeholder {
    width: 80px;
    height: 80px;
    background: #e9ecef;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 24px;
}

.item-details {
    flex: 1;
}

.item-details h4 {
    margin: 0 0 5px 0;
    color: #212529;
    font-size: 1.1rem;
}

.item-description {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.item-meta {
    display: flex;
    gap: 10px;
}

.item-type {
    font-size: 0.8rem;
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: 600;
}

.item-type.service {
    background: #e0f2fe;
    color: #0369a1;
}

.item-type.menu {
    background: #dcfce7;
    color: #166534;
}

.item-quantity {
    font-size: 0.9rem;
    color: #6c757d;
}

.item-pricing {
    text-align: right;
}

.item-price {
    font-size: 1.1rem;
    font-weight: 600;
    color: #212529;
}

.item-total {
    font-size: 0.9rem;
    color: #6c757d;
}

.order-summary {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px dashed #dee2e6;
    font-size: 1rem;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-row.total {
    font-size: 1.2rem;
    color: #212529;
}

.checkout-form {
    margin-top: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #495057;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
}

/* Location Input Styles */
.location-input {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.location-input textarea.form-control {
    flex: 1;
    min-height: 100px;
    resize: vertical;
}

.location-btn {
    padding: 12px 20px;
    background: #f8fafc;
    color: #475569;
    border: 1.5px solid #cbd5e1;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    white-space: nowrap;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    height: fit-content;
}

.location-btn:hover {
    background: #f1f5f9;
    border-color: #3b82f6;
    color: #3b82f6;
}

.location-btn i {
    font-size: 14px;
}

.help-text {
    display: block;
    margin-top: 6px;
    color: #64748b;
    font-size: 12px;
    min-height: 18px;
}

.payment-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.payment-option {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.payment-option:hover {
    border-color: #4dabf7;
    background: #f8f9fa;
}

.payment-option input[type="radio"] {
    display: none;
}

.payment-option input[type="radio"]:checked + .option-content {
    color: #4dabf7;
}

.payment-option input[type="radio"]:checked {
    border-color: #4dabf7;
    background: #e7f5ff;
}

.option-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-size: 0.9rem;
}

.option-content i {
    font-size: 24px;
}

.terms {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.95rem;
}

.checkout-actions {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-confirm {
    flex: 1;
    font-size: 1.1rem;
}

.empty-cart {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-cart i {
    margin-bottom: 20px;
}

.empty-cart h3 {
    font-size: 1.3rem;
    margin-bottom: 10px;
}

.empty-cart p {
    font-size: 1rem;
    margin-bottom: 20px;
}

/* Location Message Styles */
#locationMessage {
    margin-top: 10px;
    font-size: 14px;
    padding: 10px 14px;
    border-radius: 8px;
    font-weight: 500;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Mobile Optimization */
@media (max-width: 768px) {
    .cart-item-card {
        flex-direction: column;
        text-align: center;
    }
    
    .item-meta {
        justify-content: center;
    }
    
    .payment-options {
        grid-template-columns: 1fr;
    }
    
    .checkout-actions {
        flex-direction: column;
    }
    
    .location-input {
        flex-direction: column;
        gap: 12px;
    }
    
    .location-btn {
        width: 100%;
        justify-content: center;
    }
    
    /* User details mobile optimization */
    .user-details-section {
        margin-top: 25px;
        padding-top: 20px;
    }
    
    .user-details-section h2 {
        font-size: 1.2rem;
        margin-bottom: 12px;
    }
    
    .detail-row {
        flex-direction: column;
        align-items: flex-start;
        padding: 6px 0;
    }
    
    .detail-label {
        min-width: auto;
        margin-bottom: 2px;
    }
    
    .detail-value {
        text-align: left;
        margin-left: 0;
        white-space: normal;
    }
}

/* Mobile Optimization for smaller screens */
@media (min-width: 576px) and (max-width: 767px) {
    /* Large Mobile */
    .checkout-container {
        font-size: 90%;
    }
    
    .user-details-section h2 {
        font-size: 1.2rem;
    }
    
    .detail-row {
        font-size: 0.85rem;
    }
    
    .detail-label {
        font-size: 0.8rem;
    }
    
    .detail-value {
        font-size: 0.85rem;
    }
    
    .location-btn {
        padding: 10px 16px;
        font-size: 13px;
    }
}

@media (max-width: 575px) {
    /* Small Mobile */
    .checkout-container {
        font-size: 90%;
    }
    
    .checkout-section {
        padding: 20px;
    }
    
    .user-details-section {
        margin-top: 20px;
        padding-top: 15px;
    }
    
    .user-details-section h2 {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }
    
    .user-details-card {
        padding: 12px;
    }
}
</style>

<!-- Location Detection JavaScript from checkout5.html -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationBtn = document.getElementById('locationBtn');
    const locationInput = document.getElementById('delivery_location');
    const locationHelp = document.getElementById('locationHelp');
    const locationCombined = document.getElementById('location_combined');
    
    if (!locationBtn) return;
    
    // Cache for location (last 30 seconds)
    let cachedLocation = null;
    let cacheTimestamp = null;
    const CACHE_DURATION = 30000; // 30 seconds
    
    // Check for cached location
    function getCachedLocation() {
        if (!cachedLocation || !cacheTimestamp) return null;
        
        const now = Date.now();
        if (now - cacheTimestamp < CACHE_DURATION) {
            console.log('üìç Using cached location');
            return cachedLocation;
        }
        return null;
    }
    
    // Location button click handler
    async function handleGetLocation() {
        // Check if we have cached location
        const cached = getCachedLocation();
        if (cached) {
            applyLocationData(cached);
            showLocationMessage('‚úÖ Location loaded from cache!', 'success');
            locationHelp.textContent = 'Cached location loaded successfully!';
            locationHelp.style.color = '#10b981';
            return;
        }
        
        // Check if browser supports geolocation
        if (!navigator.geolocation) {
            showLocationMessage('Your browser does not support location detection.', 'error');
            locationHelp.textContent = 'Browser not supported. Please enter address manually.';
            locationHelp.style.color = '#ef4444';
            return;
        }
        
        // Show loading state
        const originalBtnHTML = locationBtn.innerHTML;
        locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        locationBtn.disabled = true;
        
        // Show loading message
        showLocationMessage('<i class="fas fa-spinner fa-spin"></i> Getting your location...', 'info');
        locationHelp.textContent = 'Detecting location...';
        locationHelp.style.color = '#3b82f6';
        
        // OPTIMIZED OPTIONS for FAST detection:
        const geolocationOptions = {
            enableHighAccuracy: false, // false for faster response
            timeout: 3000,            // 3 seconds timeout
            maximumAge: 30000         // Accept cached location up to 30 seconds old
        };
        
        // FAST geolocation request
        navigator.geolocation.getCurrentPosition(
            // Success callback
            async function(position) {
                try {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const accuracy = position.coords.accuracy || 50;
                    
                    console.log('üìç Location detected');
                    console.log('üìç Accuracy:', accuracy, 'meters');
                    
                    // Cache the coordinates immediately
                    cachedLocation = {
                        coords: { latitude, longitude, accuracy },
                        timestamp: position.timestamp
                    };
                    cacheTimestamp = Date.now();
                    
                    // Get address in background
                    getAddressAsync(latitude, longitude);
                    
                    // Generate Google Maps permanent link
                    const mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
                    
                    // ‚úÖ FORMAT: "Address | Latitude | Longitude | MapLink | Accuracy"
                    const combinedData = `${latitude} | ${longitude} | ${mapLink} | ${accuracy}m`;
                    
                    // Store in hidden field
                    locationCombined.value = combinedData;
                    
                    // Show immediate feedback to user (village/city/area format)
                    locationInput.value = `üìç Location detected (Accuracy: ${accuracy}m)`;
                    
                    // Success message
                    showLocationMessage('‚úÖ Location detected successfully!', 'success');
                    locationHelp.textContent = `Accuracy: ${accuracy} meters`;
                    locationHelp.style.color = accuracy < 50 ? '#10b981' : '#f59e0b';
                    
                    console.log('üì¶ Location data stored');
                    
                } catch (error) {
                    console.error('Error processing location:', error);
                    showLocationMessage('‚úÖ Location captured', 'success');
                    locationHelp.textContent = 'Coordinates captured successfully.';
                    locationHelp.style.color = '#f59e0b';
                } finally {
                    // Restore button
                    locationBtn.innerHTML = originalBtnHTML;
                    locationBtn.disabled = false;
                }
            },
            
            // Error callback
            function(error) {
                // Restore button
                locationBtn.innerHTML = originalBtnHTML;
                locationBtn.disabled = false;
                
                let errorMessage = 'Unable to detect location. Please enter address manually.';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'üìç Please allow location access in browser settings.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'üìç Device location unavailable. Please enable GPS/WiFi.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'üìç Signal weak. Please try again or enter manually.';
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMessage = 'üìç Location service error. Please try again.';
                        break;
                }
                
                // Show error message
                showLocationMessage(errorMessage, 'error');
                locationHelp.textContent = 'Location detection failed';
                locationHelp.style.color = '#ef4444';
                
                // Clear hidden field
                locationCombined.value = '';
                
                console.log('‚ùå Geolocation error:', error.message);
            },
            
            geolocationOptions
        );
    }
    
    // Async function to get address (runs in background)
    async function getAddressAsync(lat, lon) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`,
                {
                    headers: {
                        'User-Agent': 'CheckoutApp/1.0',
                        'Accept-Language': 'en'
                    }
                }
            );
            
            if (!response.ok) throw new Error('Network error');
            
            const data = await response.json();
            
            if (data.display_name) {
                // Extract village/city/area/pincode from address
                const address = data.display_name;
                
                // Update the input field with formatted address
                locationInput.value = address;
                
                // Update combined data with address
                const mapLink = `https://www.google.com/maps?q=${lat},${lon}`;
                const accuracy = cachedLocation?.coords?.accuracy || 'Unknown';
                const combinedData = `${address} | ${lat} | ${lon} | ${mapLink} | ${accuracy}m`;
                locationCombined.value = combinedData;
                
                // Update cache
                if (cachedLocation) {
                    cachedLocation.address = address;
                }
                
                // Update success message
                showLocationMessage('‚úÖ Full address retrieved!', 'success');
                locationHelp.textContent = 'Address details added successfully!';
                locationHelp.style.color = '#10b981';
                
                console.log('üè† Address retrieved:', address);
            }
            
        } catch (error) {
            console.warn('Address lookup failed:', error);
            // No error shown to user
        }
    }
    
    // Apply cached location data
    function applyLocationData(locationData) {
        const lat = locationData.coords.latitude;
        const lon = locationData.coords.longitude;
        const accuracy = locationData.coords.accuracy || 'Unknown';
        const mapLink = `https://www.google.com/maps?q=${lat},${lon}`;
        
        let combinedData = `${lat} | ${lon} | ${mapLink} | ${accuracy}m`;
        let displayValue = `üìç Location detected (Accuracy: ${accuracy}m)`;
        
        if (locationData.address) {
            combinedData = `${locationData.address} | ${lat} | ${lon} | ${mapLink} | ${accuracy}m`;
            displayValue = locationData.address;
        }
        
        locationCombined.value = combinedData;
        locationInput.value = displayValue;
        
        // Show accuracy in help text
        locationHelp.textContent = `Accuracy: ${accuracy} meters (Cached)`;
        locationHelp.style.color = accuracy < 50 ? '#10b981' : '#f59e0b';
        
        // Restore button
        locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> <span>Get Current Location</span>';
        locationBtn.disabled = false;
    }
    
    // Function to show location messages
    function showLocationMessage(text, type) {
        // Remove existing message
        const existingMsg = document.getElementById('locationMessage');
        if (existingMsg) existingMsg.remove();
        
        // Create message element
        const msgDiv = document.createElement('div');
        msgDiv.id = 'locationMessage';
        msgDiv.innerHTML = text;
        msgDiv.style.cssText = `
            margin-top: 10px;
            font-size: 14px;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 500;
            ${type === 'success' ? 
                'background: #d1fae5; color: #065f46; border: 1px solid #10b981;' : 
                type === 'info' ?
                'background: #e0f2fe; color: #0369a1; border: 1px solid #0ea5e9;' :
                type === 'warning' ?
                'background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;' :
                'background: #fee2e2; color: #991b1b; border: 1px solid #ef4444;'
            }
            animation: fadeIn 0.3s ease;
        `;
        
        // Insert after location input
        const locationGroup = locationInput.closest('.form-group');
        if (locationGroup) {
            locationGroup.appendChild(msgDiv);
        }
    }
    
    // Form submit handler
    const form = document.querySelector('.checkout-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Check if combined location data exists
            if (locationCombined && locationCombined.value) {
                // Ensure we have proper location data
                const combinedValue = locationCombined.value;
                
                // ‚úÖ Replace visible location with address only (for customer)
                // Extract address from combined data
                const parts = combinedValue.split(' | ');
                if (parts.length >= 1) {
                    // If first part is address, use it; otherwise use coordinates
                    if (parts[0].includes(',') && !parts[0].includes('http')) {
                        locationInput.value = parts[0]; // Address
                    } else if (parts.length >= 2) {
                        // Check if second part could be address
                        locationInput.value = parts[1] || parts[0]; // Try second part
                    }
                }
                
                console.log('üì§ Submitting combined location data to server:', combinedValue);
            } else {
                // Manual entry - store as is
                console.log('üì§ Submitting manual location:', locationInput.value);
            }
        });
    }
    
    // Attach click event to location button
    locationBtn.addEventListener('click', handleGetLocation);
});
</script>
{% endblock %}