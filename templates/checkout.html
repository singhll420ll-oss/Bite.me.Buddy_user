<!-- checkout.html - COMPLETE VERSION -->
{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Top Header - Original Version -->
    <header class="dashboard-header">
        <div class="header-left">
            <h1>Checkout</h1>
            <p class="welcome-text">Review your order</p>
        </div>
        <div class="header-right">
            <img src="{{ session.profile_pic }}" 
                 alt="Profile" class="profile-pic"
                 onerror="this.src='{{ url_for('static', filename='default-avatar.jpg') }}'">
        </div>
    </header>

    <main class="main-content">
        <div class="checkout-container">
            <!-- User Details Section - IMPROVED -->
            <div class="checkout-section">
                <h2><i class="fas fa-user-circle"></i> Your Details</h2>
                <div class="user-details-card">
                    <div class="detail-row">
                        <span class="detail-label">Full Name:</span>
                        <span class="detail-value">{{ session.full_name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email Address:</span>
                        <span class="detail-value">{{ session.email }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Mobile Number:</span>
                        <span class="detail-value">{{ session.phone }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Delivery Address:</span>
                        <span class="detail-value">
                            {% if session.location %}
                                {{ session.location }}
                                {% if session.pincode %}
                                    <br><span style="color: #666; font-size: 0.9em;">Pincode: {{ session.pincode }}</span>
                                {% endif %}
                            {% else %}
                                Address not specified
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Order Items Section -->
            <div class="checkout-section">
                <h2><i class="fas fa-shopping-cart"></i> Order Items ({{ cart_items|length }})</h2>
                
                {% if cart_items and cart_items|length > 0 %}
                <div class="cart-items-list">
                    {% for item in cart_items %}
                    <div class="cart-item-card">
                        {% if item.details.photo %}
                        <img src="{{ item.details.photo }}" 
                             alt="{{ item.details.name }}" 
                             class="item-photo"
                             onerror="this.src='{{ url_for('static', filename='default-item.jpg') }}'">
                        {% else %}
                        <div class="item-photo-placeholder">
                            <i class="fas fa-{{ 'concierge-bell' if item.type == 'service' else 'utensils' }}"></i>
                        </div>
                        {% endif %}
                        
                        <div class="item-details">
                            <h4>{{ item.details.name }}</h4>
                            <p class="item-description">{{ item.details.description|default('No description available') }}</p>
                            <div class="item-meta">
                                <span class="item-type {{ item.type }}">{{ item.type|title }}</span>
                                <span class="item-quantity">Qty: {{ item.quantity }}</span>
                            </div>
                        </div>
                        
                        <div class="item-pricing">
                            <div class="item-price">‚Çπ{{ "%.2f"|format(item.details.price) }}</div>
                            <div class="item-total">‚Çπ{{ "%.2f"|format(item.item_total) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>‚Çπ{{ "%.2f"|format(cart_total) }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Charge</span>
                        <span>‚Çπ0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span><strong>Total Amount</strong></span>
                        <span><strong>‚Çπ{{ "%.2f"|format(cart_total) }}</strong></span>
                    </div>
                </div>
                {% else %}
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart fa-3x"></i>
                    <h3>Your cart is empty</h3>
                    <p>Add items to cart before checkout</p>
                    <div class="empty-cart-buttons">
                        <a href="{{ url_for('services') }}" class="btn btn-primary">
                            <i class="fas fa-concierge-bell"></i> Browse Services
                        </a>
                        <a href="{{ url_for('menu') }}" class="btn btn-primary">
                            <i class="fas fa-utensils"></i> Browse Menu
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Checkout Form -->
            {% if cart_items and cart_items|length > 0 %}
            <div class="checkout-section">
                <h2><i class="fas fa-credit-card"></i> Payment & Delivery</h2>
                <form method="POST" action="{{ url_for('checkout') }}" class="checkout-form" id="checkoutForm">
                    <!-- Delivery Location with Get Current Location Button -->
                    <div class="form-group">
                        <label for="delivery_location">
                            <i class="fas fa-map-marker-alt"></i> Delivery Address
                        </label>
                        <div class="location-input">
                            <textarea id="delivery_location" name="delivery_location" 
                                      class="form-control" rows="3" required
                                      placeholder="Enter complete delivery address with village/city, area and pincode">
                                {% if session.location %}
                                    {{ session.location }}
                                    {% if session.pincode %}
                                        {% if not session.pincode in session.location %}
                                            , Pincode: {{ session.pincode }}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </textarea>
                            <button type="button" class="location-btn" id="locationBtn">  
                                <i class="fas fa-map-marker-alt"></i> 
                                <span>Get Current Location</span>
                            </button>
                        </div>
                        <small id="locationHelp" class="help-text"></small>
                        <!-- Hidden field for combined location data -->
                        <input type="hidden" id="location_combined" name="location_combined">
                    </div>
                    
                    <!-- Payment Mode -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-money-bill-wave"></i> Payment Method
                        </label>
                        <div class="payment-options">
                            <label class="payment-option">
                                <input type="radio" name="payment_mode" value="COD" checked>
                                <div class="option-content">
                                    <i class="fas fa-money-bill"></i>
                                    <span>Cash on Delivery (COD)</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="payment_mode" value="UPI">
                                <div class="option-content">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span>UPI / PhonePe / GPay</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="payment_mode" value="Card">
                                <div class="option-content">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Credit/Debit Card</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Terms & Submit -->
                    <div class="form-group terms">
                        <label>
                            <input type="checkbox" required id="termsCheckbox">
                            I agree to the terms and conditions
                        </label>
                        <div id="termsNote" style="display: none; margin-top: 8px; padding: 8px 12px; background: #f0f9ff; border-radius: 6px; border: 1px solid #0ea5e9; font-size: 0.9rem;">
                            <i class="fas fa-info-circle" style="color: #0ea5e9; margin-right: 5px;"></i>
                            <span>Location will be automatically detected for accurate delivery.</span>
                        </div>
                    </div>
                    
                    <div class="checkout-actions">
                        <a href="{{ url_for('cart') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Cart
                        </a>
                        <button type="submit" class="btn btn-success btn-confirm" id="submitBtn">
                            <i class="fas fa-check-circle"></i> Confirm Order (‚Çπ{{ "%.2f"|format(cart_total) }})
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Bottom Navigation - Plain HTML (Jaisa screenshot mein dikh raha hai) -->
    <nav>
        <a href="{{ url_for('services') }}">
            <i class="fas fa-concierge-bell"></i>
            Services
        </a>
        <a href="{{ url_for('menu') }}">
            <i class="fas fa-utensils"></i>
            Menu
        </a>
        <a href="{{ url_for('cart') }}">
            <i class="fas fa-shopping-cart"></i>
            Cart
        </a>
        <a href="{{ url_for('order_history') }}">
            <i class="fas fa-history"></i>
            Orders
        </a>
        <a href="{{ url_for('profile') }}">
            <i class="fas fa-user"></i>
            Profile
        </a>
    </nav>
</div>

<!-- Checkout Styles with Mobile Optimization -->
<style>
.checkout-container {
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 70px; /* Space for bottom nav */
}

.checkout-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #eaeaea;
}

.checkout-section h2 {
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.5rem;
}

/* Your Details Section - IMPROVED - 10% BIGGER */
.user-details-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 25px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 1.1em; /* 10% bigger */
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: #495057;
    font-weight: 600;
    font-size: 1.05em; /* 10% bigger */
    min-width: 150px;
}

.detail-value {
    color: #212529;
    font-weight: 500;
    font-size: 1.1em; /* 10% bigger */
    text-align: right;
    flex: 1;
    line-height: 1.4;
}

/* Order Items Section Optimization */
.checkout-section:nth-child(2) {
    opacity: 0.9; /* 10% opacity reduction */
    padding: 20px;
}

.cart-items-list {
    margin: 15px 0;
}

.cart-item-card {
    display: grid;
    grid-template-columns: 80px 1fr auto;
    align-items: center;
    gap: 15px;
    padding: 12px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #fff;
    transition: all 0.2s ease;
}

.cart-item-card:hover {
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}

.item-photo {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    opacity: 1; /* Photo opacity unchanged */
}

.item-photo-placeholder {
    width: 80px;
    height: 80px;
    background: #e9ecef;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 24px;
    opacity: 1; /* Photo opacity unchanged */
}

.item-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.item-details h4 {
    margin: 0;
    color: #212529;
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.3;
}

.item-description {
    color: #6c757d;
    font-size: 0.85rem;
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-meta {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 3px;
}

.item-type {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.item-type.service {
    background: #e0f2fe;
    color: #0369a1;
}

.item-type.menu {
    background: #dcfce7;
    color: #166534;
}

.item-quantity {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 500;
}

.item-pricing {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 5px;
    min-width: 80px;
}

.item-price {
    font-size: 0.95rem;
    font-weight: 600;
    color: #212529;
}

.item-total {
    font-size: 0.8rem;
    color: #6c757d;
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
}

.order-summary {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    opacity: 0.9; /* 10% opacity reduction */
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed #dee2e6;
    font-size: 0.95rem;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-row.total {
    font-size: 1.05rem;
    color: #212529;
    font-weight: 700;
    margin-top: 5px;
    padding-top: 10px;
    border-top: 2px solid #dee2e6;
}

.checkout-form {
    margin-top: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #495057;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
}

/* Location Input Styles */
.location-input {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.location-input textarea.form-control {
    flex: 1;
    min-height: 100px;
    resize: vertical;
}

.location-btn {
    padding: 12px 20px;
    background: #f8fafc;
    color: #475569;
    border: 1.5px solid #cbd5e1;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    white-space: nowrap;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    height: fit-content;
}

.location-btn:hover {
    background: #f1f5f9;
    border-color: #3b82f6;
    color: #3b82f6;
}

.location-btn i {
    font-size: 14px;
}

.help-text {
    display: block;
    margin-top: 6px;
    color: #64748b;
    font-size: 12px;
    min-height: 18px;
}

.payment-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.payment-option {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.payment-option:hover {
    border-color: #4dabf7;
    background: #f8f9fa;
}

.payment-option input[type="radio"] {
    display: none;
}

.payment-option input[type="radio"]:checked + .option-content {
    color: #4dabf7;
}

.payment-option input[type="radio"]:checked {
    border-color: #4dabf7;
    background: #e7f5ff;
}

.option-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-size: 0.9rem;
}

.option-content i {
    font-size: 24px;
}

.terms {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.95rem;
}

.checkout-actions {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-confirm {
    flex: 1;
    font-size: 1.1rem;
}

/* Empty Cart Section with Gap between buttons */
.empty-cart {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-cart i {
    margin-bottom: 20px;
}

.empty-cart h3 {
    font-size: 1.3rem;
    margin-bottom: 10px;
}

.empty-cart p {
    font-size: 1rem;
    margin-bottom: 30px;
}

.empty-cart-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    align-items: center;
}

.empty-cart-buttons .btn {
    margin: 5px;
}

/* Location Message Styles */
#locationMessage {
    margin-top: 10px;
    font-size: 14px;
    padding: 10px 14px;
    border-radius: 8px;
    font-weight: 500;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive Design for Improved Your Details Section */
@media (max-width: 768px) {
    .user-details-card {
        padding: 20px;
    }
    
    .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        padding: 10px 0;
    }
    
    .detail-label {
        min-width: auto;
        font-size: 1em;
    }
    
    .detail-value {
        text-align: left;
        font-size: 1.05em;
    }
}

@media (max-width: 576px) {
    .user-details-card {
        padding: 15px;
    }
    
    .detail-row {
        padding: 8px 0;
    }
    
    .detail-label {
        font-size: 0.95em;
    }
    
    .detail-value {
        font-size: 1em;
    }
}

/* Mobile Responsive for Order Items Section */
@media (max-width: 768px) {
    .checkout-section:nth-child(2) {
        padding: 15px;
    }
    
    .cart-item-card {
        grid-template-columns: 70px 1fr auto;
        gap: 10px;
        padding: 10px;
        margin-bottom: 6px;
    }
    
    .item-photo, 
    .item-photo-placeholder {
        width: 70px;
        height: 70px;
    }
    
    .item-details h4 {
        font-size: 0.95rem;
    }
    
    .item-description {
        font-size: 0.8rem;
        -webkit-line-clamp: 2;
    }
    
    .item-type {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    
    .item-quantity {
        font-size: 0.75rem;
    }
    
    .item-pricing {
        min-width: 70px;
    }
    
    .item-price {
        font-size: 0.9rem;
    }
    
    .item-total {
        font-size: 0.75rem;
    }
    
    .order-summary {
        padding: 12px;
    }
    
    .summary-row {
        font-size: 0.9rem;
        padding: 6px 0;
    }
    
    .summary-row.total {
        font-size: 1rem;
    }
}

@media (max-width: 576px) {
    .cart-item-card {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        text-align: center;
    }
    
    .item-photo, 
    .item-photo-placeholder {
        width: 100%;
        height: 150px;
        margin: 0 auto;
    }
    
    .item-photo-placeholder i {
        font-size: 36px;
    }
    
    .item-meta {
        justify-content: center;
    }
    
    .item-pricing {
        align-items: center;
        flex-direction: row;
        justify-content: center;
        gap: 10px;
        margin-top: 5px;
    }
}

/* Mobile Optimization for Other Sections */
@media (min-width: 576px) and (max-width: 767px) {
    /* Large Mobile - 15% compression */
    .checkout-container {
        font-size: 85%;
    }
    
    .form-group label {
        font-size: calc(1rem * 0.85);
    }
    
    .form-control {
        font-size: calc(1rem * 0.85);
        padding: calc(12px * 0.85);
    }
    
    .option-content {
        font-size: calc(0.9rem * 0.85);
    }
    
    .option-content i {
        font-size: calc(24px * 0.85) !important;
    }
    
    .terms {
        font-size: calc(0.95rem * 0.85);
        padding: calc(15px * 0.85);
    }
    
    .btn {
        font-size: calc(1rem * 0.85);
        padding: calc(12px * 0.85) calc(24px * 0.85);
    }
    
    .btn-confirm {
        font-size: calc(1.1rem * 0.85);
    }
    
    .empty-cart h3 {
        font-size: calc(1.3rem * 0.85);
    }
    
    .empty-cart p {
        font-size: calc(1rem * 0.85);
    }
    
    .checkout-section {
        padding: calc(25px * 0.85);
        margin-bottom: calc(20px * 0.85);
    }
    
    .checkout-form {
        margin-top: calc(20px * 0.85);
    }
    
    .form-group {
        margin-bottom: calc(20px * 0.85);
    }
    
    .payment-option {
        padding: calc(15px * 0.85);
    }
    
    .checkout-actions {
        margin-top: calc(30px * 0.85);
        gap: calc(15px * 0.85);
    }
    
    /* Location button mobile optimization */
    .location-btn {
        padding: calc(12px * 0.85) calc(20px * 0.85);
        font-size: calc(14px * 0.85);
    }
    
    .location-btn i {
        font-size: calc(14px * 0.85) !important;
    }
    
    /* Empty cart buttons mobile */
    .empty-cart-buttons {
        gap: calc(15px * 0.85);
    }
    
    .empty-cart-buttons .btn {
        margin: calc(5px * 0.85);
    }
    
    /* Font Awesome Icons */
    .fas {
        font-size: 85% !important;
    }
}

@media (min-width: 375px) and (max-width: 575px) {
    /* Small Mobile - 15% compression */
    .checkout-container {
        font-size: 85%;
    }
    
    .form-group label {
        font-size: calc(1rem * 0.85);
    }
    
    .form-control {
        font-size: calc(1rem * 0.85);
        padding: calc(12px * 0.85);
    }
    
    .option-content {
        font-size: calc(0.9rem * 0.85);
    }
    
    .option-content i {
        font-size: calc(24px * 0.85) !important;
    }
    
    .terms {
        font-size: calc(0.95rem * 0.85);
        padding: calc(15px * 0.85);
    }
    
    .btn {
        font-size: calc(1rem * 0.85);
        padding: calc(12px * 0.85) calc(24px * 0.85);
    }
    
    .btn-confirm {
        font-size: calc(1.1rem * 0.85);
    }
    
    .empty-cart h3 {
        font-size: calc(1.3rem * 0.85);
    }
    
    .empty-cart p {
        font-size: calc(1rem * 0.85);
    }
    
    .checkout-section {
        padding: calc(25px * 0.85);
        margin-bottom: calc(20px * 0.85);
    }
    
    .checkout-form {
        margin-top: calc(20px * 0.85);
    }
    
    .form-group {
        margin-bottom: calc(20px * 0.85);
    }
    
    .payment-option {
        padding: calc(15px * 0.85);
    }
    
    .checkout-actions {
        margin-top: calc(30px * 0.85);
        gap: calc(15px * 0.85);
    }
    
    /* Location button mobile optimization */
    .location-btn {
        padding: calc(12px * 0.85) calc(20px * 0.85);
        font-size: calc(14px * 0.85);
    }
    
    .location-btn i {
        font-size: calc(14px * 0.85) !important;
    }
    
    /* Empty cart buttons mobile */
    .empty-cart-buttons {
        gap: calc(15px * 0.85);
        flex-direction: column;
    }
    
    .empty-cart-buttons .btn {
        width: 100%;
        margin: 5px 0;
    }
    
    /* Font Awesome Icons */
    .fas {
        font-size: 85% !important;
    }
    
    .payment-options {
        grid-template-columns: 1fr;
    }
    
    .checkout-actions {
        flex-direction: column;
    }
    
    /* Location input responsive */
    .location-input {
        flex-direction: column;
        gap: 12px;
    }
    
    .location-btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 374px) {
    /* Extra Small Mobile - 15% compression */
    .checkout-container {
        font-size: 85%;
    }
    
    .form-group label {
        font-size: calc(1rem * 0.85);
    }
    
    .form-control {
        font-size: calc(1rem * 0.85);
        padding: calc(12px * 0.85);
    }
    
    .option-content {
        font-size: calc(0.9rem * 0.85);
    }
    
    .option-content i {
        font-size: calc(24px * 0.85) !important;
    }
    
    .terms {
        font-size: calc(0.95rem * 0.85);
        padding: calc(15px * 0.85);
    }
    
    .btn {
        font-size: calc(1rem * 0.85);
        padding: calc(12px * 0.85) calc(24px * 0.85);
    }
    
    .btn-confirm {
        font-size: calc(1.1rem * 0.85);
    }
    
    .empty-cart h3 {
        font-size: calc(1.3rem * 0.85);
    }
    
    .empty-cart p {
        font-size: calc(1rem * 0.85);
    }
    
    .checkout-section {
        padding: calc(25px * 0.85);
        margin-bottom: calc(20px * 0.85);
    }
    
    .checkout-form {
        margin-top: calc(20px * 0.85);
    }
    
    .form-group {
        margin-bottom: calc(20px * 0.85);
    }
    
    .payment-option {
        padding: calc(15px * 0.85);
    }
    
    .checkout-actions {
        margin-top: calc(30px * 0.85);
        gap: calc(15px * 0.85);
    }
    
    /* Location button mobile optimization */
    .location-btn {
        padding: calc(12px * 0.85) calc(20px * 0.85);
        font-size: calc(14px * 0.85);
    }
    
    .location-btn i {
        font-size: calc(14px * 0.85) !important;
    }
    
    /* Empty cart buttons mobile */
    .empty-cart-buttons {
        gap: calc(15px * 0.85);
        flex-direction: column;
    }
    
    .empty-cart-buttons .btn {
        width: 100%;
        margin: 5px 0;
    }
    
    /* Font Awesome Icons */
    .fas {
        font-size: 85% !important;
    }
    
    .payment-options {
        grid-template-columns: 1fr;
    }
    
    .checkout-actions {
        flex-direction: column;
    }
    
    /* Location input responsive */
    .location-input {
        flex-direction: column;
        gap: 12px;
    }
    
    .location-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<!-- Location Detection JavaScript with Automatic Location on Terms Check -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationBtn = document.getElementById('locationBtn');
    const locationInput = document.getElementById('delivery_location');
    const locationHelp = document.getElementById('locationHelp');
    const locationCombined = document.getElementById('location_combined');
    const termsCheckbox = document.getElementById('termsCheckbox');
    const checkoutForm = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    const termsNote = document.getElementById('termsNote');
    
    if (!locationBtn) return;
    
    // Cache for location (last 30 seconds)
    let cachedLocation = null;
    let cacheTimestamp = null;
    const CACHE_DURATION = 30000; // 30 seconds
    
    // Track if location has been auto-detected
    let locationAutoDetected = false;
    
    // Check for cached location
    function getCachedLocation() {
        if (!cachedLocation || !cacheTimestamp) return null;
        
        const now = Date.now();
        if (now - cacheTimestamp < CACHE_DURATION) {
            console.log('üìç Using cached location');
            return cachedLocation;
        }
        return null;
    }
    
    // Function to extract address components
    function formatAddress(addressData) {
        const address = addressData.address || {};
        let formattedParts = [];
        
        // Add village/town/city
        if (address.village) {
            formattedParts.push(address.village);
        } else if (address.town) {
            formattedParts.push(address.town);
        } else if (address.city) {
            formattedParts.push(address.city);
        }
        
        // Add district
        if (address.county) {
            formattedParts.push(address.county);
        }
        
        // Add state
        if (address.state) {
            formattedParts.push(address.state);
        }
        
        // Add postcode
        if (address.postcode) {
            formattedParts.push(address.postcode);
        }
        
        // Add country
        if (address.country) {
            formattedParts.push(address.country);
        }
        
        return formattedParts.join(', ');
    }
    
    // Main function to get location (used by both button click and auto-detection)
    async function handleGetLocation(isAuto = false) {
        // If auto-detection and location already detected, don't do it again
        if (isAuto && locationAutoDetected) {
            console.log('üìç Location already auto-detected, skipping');
            return;
        }
        
        // Check if we have cached location
        const cached = getCachedLocation();
        if (cached) {
            applyLocationData(cached);
            if (isAuto) {
                showLocationMessage('‚úÖ Location loaded from cache automatically!', 'success');
                locationHelp.textContent = 'Cached location loaded automatically!';
            } else {
                showLocationMessage('‚úÖ Location loaded from cache!', 'success');
                locationHelp.textContent = 'Cached location loaded successfully!';
            }
            locationHelp.style.color = '#10b981';
            return;
        }
        
        // Check if browser supports geolocation
        if (!navigator.geolocation) {
            showLocationMessage('Your browser does not support location detection.', 'error');
            locationHelp.textContent = 'Browser not supported. Please enter address manually.';
            locationHelp.style.color = '#ef4444';
            return;
        }
        
        // Show loading state
        const originalBtnHTML = locationBtn.innerHTML;
        if (!isAuto) {
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            locationBtn.disabled = true;
        }
        
        // Show loading message
        if (isAuto) {
            showLocationMessage('<i class="fas fa-spinner fa-spin"></i> Auto-detecting location...', 'info');
            locationHelp.textContent = 'Auto-detecting location...';
        } else {
            showLocationMessage('<i class="fas fa-spinner fa-spin"></i> Getting your location...', 'info');
            locationHelp.textContent = 'Detecting location...';
        }
        locationHelp.style.color = '#3b82f6';
        
        // OPTIMIZED OPTIONS for FAST detection:
        const geolocationOptions = {
            enableHighAccuracy: false, // false for faster response
            timeout: 3000,            // 3 seconds timeout
            maximumAge: 30000         // Accept cached location up to 30 seconds old
        };
        
        // FAST geolocation request
        navigator.geolocation.getCurrentPosition(
            // Success callback
            async function(position) {
                try {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const accuracy = position.coords.accuracy || 50;
                    
                    if (isAuto) {
                        console.log('üìç Location auto-detected');
                        locationAutoDetected = true;
                    } else {
                        console.log('üìç Location detected');
                    }
                    console.log('üìç Accuracy:', accuracy, 'meters');
                    
                    // Cache the coordinates immediately
                    cachedLocation = {
                        coords: { latitude, longitude, accuracy },
                        timestamp: position.timestamp
                    };
                    cacheTimestamp = Date.now();
                    
                    // Get address in background
                    getAddressAsync(latitude, longitude, isAuto);
                    
                    // Generate Google Maps permanent link
                    const mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
                    
                    // ‚úÖ FORMAT: "Address | Latitude | Longitude | MapLink | Accuracy"
                    const combinedData = `${latitude} | ${longitude} | ${mapLink} | ${accuracy}m`;
                    
                    // Store in hidden field
                    locationCombined.value = combinedData;
                    
                    // Show immediate feedback to user WITHOUT COORDINATES
                    if (isAuto) {
                        locationInput.value = 'üìç Location auto-detected... Fetching address details';
                    } else {
                        locationInput.value = 'üìç Location detected... Fetching address details';
                    }
                    
                    // Success message (without coordinates)
                    if (isAuto) {
                        showLocationMessage('‚úÖ Location auto-detected successfully! Fetching address...', 'success');
                        locationHelp.textContent = 'Auto-detecting address details...';
                    } else {
                        showLocationMessage('‚úÖ Location detected successfully! Fetching address...', 'success');
                        locationHelp.textContent = 'Getting address details...';
                    }
                    locationHelp.style.color = accuracy < 50 ? '#10b981' : '#f59e0b';
                    
                    console.log('üì¶ Location data stored');
                    
                } catch (error) {
                    console.error('Error processing location:', error);
                    if (isAuto) {
                        showLocationMessage('‚úÖ Location auto-captured', 'success');
                        locationHelp.textContent = 'Coordinates auto-captured successfully.';
                    } else {
                        showLocationMessage('‚úÖ Location captured', 'success');
                        locationHelp.textContent = 'Coordinates captured successfully.';
                    }
                    locationHelp.style.color = '#f59e0b';
                } finally {
                    // Restore button
                    if (!isAuto) {
                        locationBtn.innerHTML = originalBtnHTML;
                        locationBtn.disabled = false;
                    }
                }
            },
            
            // Error callback
            function(error) {
                // Restore button
                if (!isAuto) {
                    locationBtn.innerHTML = originalBtnHTML;
                    locationBtn.disabled = false;
                }
                
                let errorMessage = 'Unable to detect location. Please enter address manually.';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'üìç Please allow location access in browser settings.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'üìç Device location unavailable. Please enable GPS/WiFi.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'üìç Signal weak. Please try again or enter manually.';
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMessage = 'üìç Location service error. Please try again.';
                        break;
                }
                
                // Show error message
                if (isAuto) {
                    showLocationMessage('‚ö†Ô∏è Could not auto-detect location. Please enter address manually.', 'warning');
                    locationHelp.textContent = 'Auto-detection failed. Please enter address.';
                } else {
                    showLocationMessage(errorMessage, 'error');
                    locationHelp.textContent = 'Location detection failed';
                }
                locationHelp.style.color = '#ef4444';
                
                // Clear hidden field
                locationCombined.value = '';
                
                console.log('‚ùå Geolocation error:', error.message);
            },
            
            geolocationOptions
        );
    }
    
    // Async function to get address (runs in background)
    async function getAddressAsync(lat, lon, isAuto = false) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`,
                {
                    headers: {
                        'User-Agent': 'CheckoutApp/1.0',
                        'Accept-Language': 'en'
                    }
                }
            );
            
            if (!response.ok) throw new Error('Network error');
            
            const data = await response.json();
            
            if (data.display_name) {
                // Extract formatted address WITHOUT coordinates
                const formattedAddress = formatAddress(data);
                
                // Use formatted address if available, otherwise use display_name
                let addressToShow = formattedAddress || data.display_name;
                
                // Remove any coordinate-like patterns from the address
                addressToShow = addressToShow.replace(/[-+]?[0-9]*\.?[0-9]+/g, '').replace(/\s+/g, ' ').trim();
                
                // Update the input field with formatted address (NO COORDINATES)
                locationInput.value = addressToShow;
                
                // Update combined data with address and coordinates (in hidden field)
                const mapLink = `https://www.google.com/maps?q=${lat},${lon}`;
                const accuracy = cachedLocation?.coords?.accuracy || 'Unknown';
                const combinedData = `${addressToShow} | ${lat} | ${lon} | ${mapLink} | ${accuracy}m`;
                locationCombined.value = combinedData;
                
                // Update cache
                if (cachedLocation) {
                    cachedLocation.address = addressToShow;
                }
                
                // Update success message (without coordinates)
                if (isAuto) {
                    showLocationMessage('‚úÖ Address auto-retrieved successfully!', 'success');
                    locationHelp.textContent = 'Address details added automatically!';
                } else {
                    showLocationMessage('‚úÖ Address retrieved successfully!', 'success');
                    locationHelp.textContent = 'Address details added to delivery field';
                }
                locationHelp.style.color = '#10b981';
                
                console.log('üè† Address retrieved:', addressToShow);
            }
            
        } catch (error) {
            console.warn('Address lookup failed:', error);
            
            // If address lookup fails, show a simple message without coordinates
            if (isAuto) {
                locationInput.value = 'üìç Location auto-detected - Please complete address manually';
                showLocationMessage('‚ö†Ô∏è Could not fetch full address. Please complete the address manually.', 'warning');
                locationHelp.textContent = 'Please complete address with house number, street, etc.';
            } else {
                locationInput.value = 'üìç Location detected - Please enter complete address manually';
                showLocationMessage('‚ö†Ô∏è Could not fetch full address. Please complete the address manually.', 'warning');
                locationHelp.textContent = 'Please complete address with house number, street, etc.';
            }
            locationHelp.style.color = '#f59e0b';
        }
    }
    
    // Apply cached location data
    function applyLocationData(locationData) {
        const lat = locationData.coords.latitude;
        const lon = locationData.coords.longitude;
        const accuracy = locationData.coords.accuracy || 'Unknown';
        const mapLink = `https://www.google.com/maps?q=${lat},${lon}`;
        
        let combinedData = `${lat} | ${lon} | ${mapLink} | ${accuracy}m`;
        let displayValue = 'üìç Cached location - Please complete address';
        
        if (locationData.address) {
            combinedData = `${locationData.address} | ${lat} | ${lon} | ${mapLink} | ${accuracy}m`;
            displayValue = locationData.address;
        }
        
        locationCombined.value = combinedData;
        locationInput.value = displayValue;
        
        // Show success message without coordinates
        locationHelp.textContent = 'Cached location loaded';
        locationHelp.style.color = accuracy < 50 ? '#10b981' : '#f59e0b';
        
        // Restore button
        locationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> <span>Get Current Location</span>';
        locationBtn.disabled = false;
    }
    
    // Function to show location messages
    function showLocationMessage(text, type) {
        // Remove existing message
        const existingMsg = document.getElementById('locationMessage');
        if (existingMsg) existingMsg.remove();
        
        // Create message element
        const msgDiv = document.createElement('div');
        msgDiv.id = 'locationMessage';
        msgDiv.innerHTML = text;
        msgDiv.style.cssText = `
            margin-top: 10px;
            font-size: 14px;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 500;
            ${type === 'success' ? 
                'background: #d1fae5; color: #065f46; border: 1px solid #10b981;' : 
                type === 'info' ?
                'background: #e0f2fe; color: #0369a1; border: 1px solid #0ea5e9;' :
                type === 'warning' ?
                'background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;' :
                'background: #fee2e2; color: #991b1b; border: 1px solid #ef4444;'
            }
            animation: fadeIn 0.3s ease;
        `;
        
        // Insert after location input
        const locationGroup = locationInput.closest('.form-group');
        if (locationGroup) {
            locationGroup.appendChild(msgDiv);
        }
    }
    
    // Terms checkbox change handler - AUTO DETECT LOCATION
    if (termsCheckbox) {
        termsCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Show note about auto location detection
                termsNote.style.display = 'block';
                
                // Auto-detect location
                console.log('‚úÖ Terms accepted, auto-detecting location...');
                handleGetLocation(true);
                
                // Add a small delay to show the note before auto-detection starts
                setTimeout(() => {
                    showLocationMessage('üîÑ Auto-detecting your location...', 'info');
                }, 300);
            } else {
                // Hide note
                termsNote.style.display = 'none';
            }
        });
    }
    
    // Form submit handler
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            // Clean any coordinate-like text from visible address before submit
            const currentValue = locationInput.value;
            
            // Remove any numbers that look like coordinates (decimal numbers)
            const cleanedValue = currentValue.replace(/[-+]?[0-9]*\.?[0-9]+/g, '').replace(/\s+/g, ' ').trim();
            
            // If cleaned value is too short, keep original but remove accuracy text
            if (cleanedValue.length < 10) {
                // Remove accuracy meter text
                locationInput.value = currentValue.replace(/\(Accuracy:\s*\d+\s*m\)/g, '').trim();
            } else {
                locationInput.value = cleanedValue;
            }
            
            // Check if combined location data exists
            if (locationCombined && locationCombined.value) {
                console.log('üì§ Submitting location data to server (coordinates hidden from user)');
                console.log('üìç Hidden data:', locationCombined.value);
            } else {
                console.log('üì§ Submitting manual location:', locationInput.value);
            }
        });
    }
    
    // Attach click event to location button
    if (locationBtn) {
        locationBtn.addEventListener('click', function() {
            handleGetLocation(false);
        });
    }
    
    // Clean any existing coordinates from location input on page load
    if (locationInput && locationInput.value) {
        const value = locationInput.value;
        // Check if value contains coordinates or accuracy info
        if (value.includes('Accuracy:') || /[-+]?[0-9]*\.?[0-9]+\s*[m]/.test(value)) {
            // Remove coordinate-like patterns
            const cleaned = value.replace(/\(Accuracy:\s*\d+\s*m\)/g, '')
                                .replace(/üìç\s*Location detected/g, '')
                                .replace(/[-+]?[0-9]*\.?[0-9]+/g, '')
                                .replace(/\s+/g, ' ')
                                .trim();
            
            // Only update if we have meaningful text left
            if (cleaned.length > 5) {
                locationInput.value = cleaned;
            } else if (value.includes('@') || value.includes('http')) {
                // Likely contains coordinates in URL format
                locationInput.value = '';
            }
        }
    }
});
</script>
{% endblock %}
